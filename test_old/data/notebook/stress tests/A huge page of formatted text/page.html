<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<body>"""<br/>
 &nbsp; &nbsp;TakeNote<br/>
 &nbsp; &nbsp;Copyright Matt Rasmussen 2008<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;Graphical User Interface for TakeNote Application<br/>
"""<br/>
<br/>
# TODO: shade undo/redo<br/>
# TODO: add pages in treeview<br/>
# &nbsp; &nbsp; &nbsp; will eventually require lazy loading for treeview<br/>
# TODO: add framework for customized page selector columns<br/>
# TODO: add html links<br/>
# TODO: make better font selector<br/>
# TODO: add colored text<br/>
<br/>
hi2<br/>
<br/>
# python imports<br/>
import sys, os, tempfile, re<br/>
<br/>
# pygtk imports<br/>
import pygtk<br/>
pygtk.require('2.0')<br/>
import gtk, gobject, pango<br/>
from gtk import gdk<br/>
<br/>
# takenote imports<br/>
import takenotelib as takenote<br/>
from takenotelib.undo import UndoStack<br/>
from takenotelib.richtext import RichTextView, RichTextImage<br/>
<br/>
# constants<br/>
PROGRAM_NAME = "TakeNode"<br/>
PROGRAM_VERSION = "0.1"<br/>
<br/>
DROP_YES = ("drop_yes", gtk.TARGET_SAME_WIDGET, 0)<br/>
DROP_NO = ("drop_no", gtk.TARGET_SAME_WIDGET, 0)<br/>
<br/>
<br/>
BASEDIR = ""<br/>
def get_resource(*path_list):<br/>
 &nbsp; &nbsp;return os.path.join(BASEDIR, *path_list)<br/>
<br/>
<br/>
def compute_new_path(model, target, drop_position):<br/>
 &nbsp; &nbsp;path = model.get_path(target)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER: &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path + (0,) #model.get_n_children(target),)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path[:-1] + (path[-1] + 1,)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
<br/>
def copy_row(treeview, model, source, target, drop_position):<br/>
<br/>
 &nbsp; &nbsp;# move source row<br/>
 &nbsp; &nbsp;source_row = model[source]<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.prepend(target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_before(None, target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_after(None, target, source_row)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
 &nbsp; &nbsp;# recursively move children<br/>
 &nbsp; &nbsp;for n in range(model.iter_n_children(source)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;child = model.iter_nth_child(source, n)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, child, new,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gtk.TREE_VIEW_DROP_INTO_OR_BEFORE)<br/>
<br/>
 &nbsp; &nbsp;# expand view to keep the same expansion pattern<br/>
 &nbsp; &nbsp;source_is_expanded = treeview.row_expanded(model.get_path(source))<br/>
 &nbsp; &nbsp;new_path = model.get_path(new)<br/>
 &nbsp; &nbsp;if source_is_expanded:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_to_path(new_path)<br/>
<br/>
 &nbsp; &nbsp;return new_path<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
class DataMap (object):<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path = {}<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data = {}<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_path(self, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.data2path.get(data, None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_data(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if isinstance(path, str):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = str2path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data.get(path, None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;assert data is not None, path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path_all(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively remove path and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for child in get_child_data(data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child_path = self.get_path(child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if child_path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.remove_path_all(child_path, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path(self, path, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path_all(self, path, data, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively add paths for data and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_path_all(path + (i,), child, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def clear_path(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data.clear()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def assert_path(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path2 = path + (i,)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child2 = self.get_data(path2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;assert child2 == child<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.assert_path(path2, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
def str2path(pathtext):<br/>
 &nbsp; &nbsp;"""Converts str to tuple path"""<br/>
 &nbsp; &nbsp;# sometime GTK returns a str instead of a tuple for a path... weird<br/>
 &nbsp; &nbsp;return tuple(map(int, pathtext.split(":")))<br/>
<br/>
<br/>
def dnd_sanity_check(source_path, target_path):<br/>
 &nbsp; &nbsp;"""The target cannot be a descendant of the source<br/>
 &nbsp; &nbsp; &nbsp; i.e. You cannot become your descendent's child<br/>
 &nbsp; &nbsp; &nbsp; i.e. The source path cannot be a prefix of the target path"""<br/>
 &nbsp; &nbsp;return source_path != target_path[:len(source_path)]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
<br/>
class TakeNoteTreeView (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a TreeStore with one string column to use as the model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.TreeStore(gdk.Pixbuf, str, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.expanded_id = self.treeview.connect("row-expanded", self.on_row_expanded)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.collapsed_id = self.treeview.connect("row-collapsed", self.on_row_collapsed) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-data-received", self.on_drag_data_received)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.get_selection().set_mode(gtk.SELECTION_MULTIPLE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_headers_visible(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_property("enable-tree-lines", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# make treeview searchable<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_search_column(1) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_reorderable(True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True) &nbsp; &nbsp; &nbsp; <br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create the treeview column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_clickable(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a cell renderers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# add the cells to column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in treestore<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = pixbuf = gdk.pixbuf_new_from_file(get_resource("images", "open.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_drag_data_received(self, treeview, drag_context, x, y,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;selection_data, info, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target = model.get_iter(target_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drop is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(source_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record old and new parent paths<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = source_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_path = compute_new_path(self.model, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent_path = new_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent = self.datamap.get_data(new_parent_path)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# remove obsolete model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(new_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(old_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in notebook model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.move(new_parent, new_path[-1])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in tree model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, source, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record new model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(new_parent_path, new_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path2 = self.datamap.get_path(old_parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent_path2 is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = old_parent_path2<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(old_parent_path, old_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# DEBUG: assert that all mappings are correct<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.assert_path((0,), lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# make sure to show new children<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_row(target_path, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(True, True, eventtime)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(False, False, eventtime)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def drop_allowed(self, source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Determine if drop is allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return dnd_sanity_check(source_path, target_path) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not (target_path == (0,) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(drop_position == gtk.TREE_VIEW_DROP_BEFORE or <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_AFTER))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_row_expanded(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(True)<br/>
<br/>
 &nbsp; &nbsp;def on_row_collapsed(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(False)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename '%s'" % node.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(self.datamap.get_data(paths[0]))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_node(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if parent is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# warn<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "Cannot delete notebook's toplevel directory"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#==============================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;root = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(None, root)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def expand_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_node(self, parent, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append(parent, [self.icon, node.get_title(), node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node.is_expanded():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(self.datamap.get_path(node))<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;expanded = self.treeview.row_expanded(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in self.model[path].iterchildren():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(child.path, lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.remove(child.iter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
class SelectorColumn (object):<br/>
 &nbsp; &nbsp;def __init__(self, name, kind, col):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.name = name<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.kind = kind<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.col = col<br/>
<br/>
TITLE_COLUMN = SelectorColumn("Title", str, 0)<br/>
CREATED_COLUMN = SelectorColumn("Created", str, 1)<br/>
MODIFIED_COLUMN = SelectorColumn("Modified", str, 2)<br/>
<br/>
<br/>
class TakeNoteSelector (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_status = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.display_columns = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.ListStore(gdk.Pixbuf, str, str, int, str, int, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.connect("rows-reordered", self.on_rows_reordered)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init view<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_rules_hint(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_title("Title")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_sort_column_id(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Created")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(3)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Modified")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 4)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = gdk.pixbuf_new_from_file(get_resource("images", "copy.xpm"))<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Create a new scrolled window, with scrollbars only if needed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC) #gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#print "drag"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_rows_reordered(self, treemodel, path, it, new_order):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;nrows = self.model.iter_n_children(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i in xrange(nrows):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path((i,), self.model[(i,)][6])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_page()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if page.get_title() != new_text:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename page '%s'" % page.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(paths[0])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.update()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#====================================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_nodes(self, nodes):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = nodes<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;npages = 0<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for node in nodes:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for page in node.get_pages():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;npages += 1<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if npages != 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("%d pages" % npages, "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("1 page", "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(self.model)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view_nodes(self.sel_nodes) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def _set_page(self, it, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 0, self.icon) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 1, page.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 2, page.get_created_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 3, page.get_created_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 4, page.get_modified_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 5, page.get_modified_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 6, page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path, col = self.treeview.get_cursor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def select_pages(self, pages):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = pages[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path != None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_status:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_status(text, bar=bar)<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
class TakeNoteEditor (object):<br/>
<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview = RichTextView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.add(self.textview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = sw<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if page is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.disable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.enable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.load(page.get_data_file())<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.page is not None and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.page.is_valid() and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.textview.is_modified():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.save(self.page.get_data_file())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.set_modified_time()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.on_page_modified:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified(self.page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save_needed(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.textview.is_modified()<br/>
<br/>
<br/>
class TakeNoteWindow (gtk.Window):<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_title("TakeNote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_default_size(*takenote.DEFAULT_WINDOW_SIZE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.connect("delete-event", lambda w,e: self.on_close())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# selector<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector = TakeNoteSelector()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_select_node = self.on_select_page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_status = self.set_status<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = TakeNoteTreeView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.on_select_node = self.on_select_treenode<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# editor<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor = TakeNoteEditor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.font_callback = self.on_font_change<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.on_page_modified = self.on_page_modified<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#====================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Layout<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# vertical box<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add(main_vbox)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;menubar = self.make_menubar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(menubar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# toolbar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(self.make_toolbar(), False, True, 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2 = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.set_border_width(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(main_vbox2, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#==========================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a horizontal paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned = gtk.HPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.pack_start(self.hpaned, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(takenote.DEFAULT_HSASH_POS)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a vertical paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned = gtk.VPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add2(self.vpaned)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(takenote.DEFAULT_VSASH_POS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# status bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox = gtk.HBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(status_hbox, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar = gtk.Statusbar() &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.status_bar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_property("has-resize-grip", False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_size_request(300, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar = gtk.Statusbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.stats_bar, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# layout major widgets<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add1(self.treeview.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add1(self.selector.view) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add2(self.editor.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.show_all() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if bar == "status":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif bar == "stats":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown bar '%s'" % bar)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.resize(*self.notebook.pref.window_size)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook.pref.window_pos != [-1, -1]:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.move(*self.notebook.pref.window_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(self.notebook.pref.vsash_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(self.notebook.pref.hsash_pos)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_size = self.get_size()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_pos = self.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.vsash_pos = self.vpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.hsash_pos = self.hpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_new_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("New Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_CREATE_FOLDER,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "New", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_new_notebook_response)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.rmdir(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.new_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("Open Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_OPEN,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Open", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_open_notebook_response)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*.nbk")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("Notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("All files")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def new_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.create()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Created '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Error: Could not create new notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename, new=True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename, new=False):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.load(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.get_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if not new:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Loaded '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def close_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_dir(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_dir("New Node")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_page("New Page")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed = self.notebook.save_needed() or \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.editor.save_needed()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if needed:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Notebook saved")<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_close(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""close the window and quit"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.main_quit()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return False<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_treenode(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = [node]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([])<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_page_modified(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update_node(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================================<br/>
 &nbsp; &nbsp;# Font UI Update<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_change(self, mods, justify):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# block toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_block(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_block(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_block(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update font mods<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"]) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update text justification<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_active(justify == "left")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_active(justify == "center")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_active(justify == "right") &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# unblock toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_unblock(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_unblock(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_unblock(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_bold(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_bold()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_italic(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_italic()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_underline(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_underline()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_left_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_left_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_center_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_center_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_right_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_right_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<br/>
 &nbsp; &nbsp;def on_screenshot(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.current_page == None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;f, imgfile = tempfile.mkstemp(".xpm", "takenote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.close(f)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.system("import %s" % imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(imgfile):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pixbuf = gdk.pixbuf_new_from_file(imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img = RichTextImage()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img.set_from_pixbuf(pixbuf)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.insert_image(img, "screenshot.jpg")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "error reading screenshot '%s'" % imgfile<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.remove(imgfile) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_choose_font(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.clicked()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_set(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_font_set(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_treeview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_listview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_editor(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_about(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Display about dialog"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about = gtk.AboutDialog()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_name(PROGRAM_NAME)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_version("v%s" % (PROGRAM_VERSION) )<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_copyright("Copyright Matt Rasmussen 2008")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_transient_for(self)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_position(gtk.WIN_POS_CENTER_ON_PARENT)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.connect("response", lambda d,r: about.destroy())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#================================================<br/>
 &nbsp; &nbsp;# Menubar<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_menubar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.menu_items = (<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_File", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_New Notebook",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, lambda w,e: self.on_new_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Page", &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;N", lambda w,e: self.on_new_page(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Directory", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;N", lambda w,e: self.on_new_dir(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Open Notebook", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;O", lambda w,e: self.on_open_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Save", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;S", lambda w,e: self.on_save(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Close Notebook", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;W", lambda w, e: self.close_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/Quit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Q", lambda w,e: self.on_close(), 0, None),<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Edit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Un_do", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Z", lambda w,e: self.editor.textview.undo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/_Redo", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;Z", lambda w,e: self.editor.textview.redo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Insert Screenshot",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Insert", lambda w,e: self.on_screenshot(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Format", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Left Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;L", lambda w,e: self.on_left_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/C_enter Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;E", lambda w,e: self.on_center_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Right Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;R", lambda w,e: self.on_right_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Bold", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;B", lambda w,e: self.on_bold(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Italic", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;I", lambda w,e: self.on_italic(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Underline", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;U", lambda w,e: self.on_underline(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep2", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/Choose _Font", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;F", lambda w, e: self.on_choose_font(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Go", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Tree View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;T", lambda w,e: self.on_goto_treeview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _List View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Y", lambda w,e: self.on_goto_listview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Editor",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;D", lambda w,e: self.on_goto_editor(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help", &nbsp; &nbsp; &nbsp; None, None, 0, "&lt;LastBranch&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help/About", None, lambda w,e: self.on_about(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;accel_group = gtk.AccelGroup()<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This function initializes the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 1: The type of menu - can be MenuBar, Menu,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or OptionMenu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 2: The path of the menu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 3: A reference to an AccelGroup. The item factory sets up<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the accelerator table while generating menus.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory = gtk.ItemFactory(gtk.MenuBar, "&lt;main&gt;", accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This method generates the menu items. Pass to the item factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp;the list of menu items<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory.create_items(self.menu_items)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Attach the new accelerator group to the window.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add_accel_group(accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# need to keep a reference to item_factory to prevent its destruction<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.item_factory = item_factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Finally, return the actual menu bar created by the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return item_factory.get_widget("&lt;main&gt;")<br/>
<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_toolbar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar = gtk.Toolbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_orientation(gtk.ORIENTATION_HORIZONTAL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_style(gtk.TOOLBAR_ICONS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips = gtk.Tooltips()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# bold tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "bold.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.bold_button, "Bold")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_id = self.bold_button.connect("toggled", lambda w: self.editor.textview.on_bold())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.bold_button, -1)<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# italic tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "italic.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.italic_button, "Italic")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_id = self.italic_button.connect("toggled", lambda w: self.editor.textview.on_italic())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.italic_button, -1)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# underline tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "underline.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.underline_button, "Underline")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_id = self.underline_button.connect("toggled", lambda w: self.editor.textview.on_underline())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.underline_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# font button<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel = gtk.FontButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item = gtk.ToolItem()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item.add(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(item, "Set Font")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(item, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.connect("font-set", lambda w: self.on_font_set())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# left tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignleft.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.left_button, "Left Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_id = self.left_button.connect("toggled", lambda w: self.editor.textview.on_left_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.left_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# center tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "aligncenter.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.center_button, "Center Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_id = self.center_button.connect("toggled", lambda w: self.editor.textview.on_center_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.center_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# right tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignright.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.right_button, "Right Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_id = self.right_button.connect("toggled", lambda w: self.editor.textview.on_right_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.right_button, -1) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return toolbar<br/>
<br/>
<br/>
class TakeNote (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;global BASEDIR<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;BASEDIR = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window = TakeNoteWindow(basedir)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window.open_notebook(filename)<br/>
<br/>
"""<br/>
 &nbsp; &nbsp;TakeNote<br/>
 &nbsp; &nbsp;Copyright Matt Rasmussen 2008<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;Graphical User Interface for TakeNote Application<br/>
"""<br/>
<br/>
# TODO: shade undo/redo<br/>
# TODO: add pages in treeview<br/>
# &nbsp; &nbsp; &nbsp; will eventually require lazy loading for treeview<br/>
# TODO: add framework for customized page selector columns<br/>
# TODO: add html links<br/>
# TODO: make better font selector<br/>
# TODO: add colored text<br/>
<br/>
<br/>
<br/>
# python imports<br/>
import sys, os, tempfile, re<br/>
<br/>
# pygtk imports<br/>
import pygtk<br/>
pygtk.require('2.0')<br/>
import gtk, gobject, pango<br/>
from gtk import gdk<br/>
<br/>
# takenote imports<br/>
import takenotelib as takenote<br/>
from takenotelib.undo import UndoStack<br/>
from takenotelib.richtext import RichTextView, RichTextImage<br/>
<br/>
# constants<br/>
PROGRAM_NAME = "TakeNode"<br/>
PROGRAM_VERSION = "0.1"<br/>
<br/>
DROP_YES = ("drop_yes", gtk.TARGET_SAME_WIDGET, 0)<br/>
DROP_NO = ("drop_no", gtk.TARGET_SAME_WIDGET, 0)<br/>
<br/>
<br/>
BASEDIR = ""<br/>
def get_resource(*path_list):<br/>
 &nbsp; &nbsp;return os.path.join(BASEDIR, *path_list)<br/>
<br/>
<br/>
def compute_new_path(model, target, drop_position):<br/>
 &nbsp; &nbsp;path = model.get_path(target)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER: &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path + (0,) #model.get_n_children(target),)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path[:-1] + (path[-1] + 1,)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
<br/>
def copy_row(treeview, model, source, target, drop_position):<br/>
<br/>
 &nbsp; &nbsp;# move source row<br/>
 &nbsp; &nbsp;source_row = model[source]<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.prepend(target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_before(None, target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_after(None, target, source_row)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
 &nbsp; &nbsp;# recursively move children<br/>
 &nbsp; &nbsp;for n in range(model.iter_n_children(source)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;child = model.iter_nth_child(source, n)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, child, new,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gtk.TREE_VIEW_DROP_INTO_OR_BEFORE)<br/>
<br/>
 &nbsp; &nbsp;# expand view to keep the same expansion pattern<br/>
 &nbsp; &nbsp;source_is_expanded = treeview.row_expanded(model.get_path(source))<br/>
 &nbsp; &nbsp;new_path = model.get_path(new)<br/>
 &nbsp; &nbsp;if source_is_expanded:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_to_path(new_path)<br/>
<br/>
 &nbsp; &nbsp;return new_path<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
class DataMap (object):<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path = {}<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data = {}<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_path(self, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.data2path.get(data, None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_data(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if isinstance(path, str):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = str2path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data.get(path, None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;assert data is not None, path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path_all(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively remove path and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for child in get_child_data(data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child_path = self.get_path(child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if child_path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.remove_path_all(child_path, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path(self, path, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path_all(self, path, data, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively add paths for data and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_path_all(path + (i,), child, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def clear_path(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data.clear()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def assert_path(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path2 = path + (i,)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child2 = self.get_data(path2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;assert child2 == child<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.assert_path(path2, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
def str2path(pathtext):<br/>
 &nbsp; &nbsp;"""Converts str to tuple path"""<br/>
 &nbsp; &nbsp;# sometime GTK returns a str instead of a tuple for a path... weird<br/>
 &nbsp; &nbsp;return tuple(map(int, pathtext.split(":")))<br/>
<br/>
<br/>
def dnd_sanity_check(source_path, target_path):<br/>
 &nbsp; &nbsp;"""The target cannot be a descendant of the source<br/>
 &nbsp; &nbsp; &nbsp; i.e. You cannot become your descendent's child<br/>
 &nbsp; &nbsp; &nbsp; i.e. The source path cannot be a prefix of the target path"""<br/>
 &nbsp; &nbsp;return source_path != target_path[:len(source_path)]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
<br/>
class TakeNoteTreeView (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a TreeStore with one string column to use as the model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.TreeStore(gdk.Pixbuf, str, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.expanded_id = self.treeview.connect("row-expanded", self.on_row_expanded)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.collapsed_id = self.treeview.connect("row-collapsed", self.on_row_collapsed) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-data-received", self.on_drag_data_received)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.get_selection().set_mode(gtk.SELECTION_MULTIPLE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_headers_visible(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_property("enable-tree-lines", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# make treeview searchable<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_search_column(1) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_reorderable(True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True) &nbsp; &nbsp; &nbsp; <br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create the treeview column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_clickable(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a cell renderers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# add the cells to column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in treestore<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = pixbuf = gdk.pixbuf_new_from_file(get_resource("images", "open.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_drag_data_received(self, treeview, drag_context, x, y,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;selection_data, info, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target = model.get_iter(target_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drop is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(source_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record old and new parent paths<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = source_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_path = compute_new_path(self.model, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent_path = new_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent = self.datamap.get_data(new_parent_path)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# remove obsolete model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(new_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(old_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in notebook model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.move(new_parent, new_path[-1])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in tree model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, source, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record new model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(new_parent_path, new_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path2 = self.datamap.get_path(old_parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent_path2 is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = old_parent_path2<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(old_parent_path, old_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# DEBUG: assert that all mappings are correct<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.assert_path((0,), lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# make sure to show new children<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_row(target_path, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(True, True, eventtime)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(False, False, eventtime)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def drop_allowed(self, source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Determine if drop is allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return dnd_sanity_check(source_path, target_path) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not (target_path == (0,) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(drop_position == gtk.TREE_VIEW_DROP_BEFORE or <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_AFTER))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_row_expanded(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(True)<br/>
<br/>
 &nbsp; &nbsp;def on_row_collapsed(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(False)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename '%s'" % node.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(self.datamap.get_data(paths[0]))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_node(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if parent is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# warn<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "Cannot delete notebook's toplevel directory"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#==============================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;root = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(None, root)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def expand_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_node(self, parent, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append(parent, [self.icon, node.get_title(), node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node.is_expanded():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(self.datamap.get_path(node))<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;expanded = self.treeview.row_expanded(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in self.model[path].iterchildren():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(child.path, lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.remove(child.iter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
class SelectorColumn (object):<br/>
 &nbsp; &nbsp;def __init__(self, name, kind, col):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.name = name<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.kind = kind<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.col = col<br/>
<br/>
TITLE_COLUMN = SelectorColumn("Title", str, 0)<br/>
CREATED_COLUMN = SelectorColumn("Created", str, 1)<br/>
MODIFIED_COLUMN = SelectorColumn("Modified", str, 2)<br/>
<br/>
<br/>
class TakeNoteSelector (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_status = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.display_columns = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.ListStore(gdk.Pixbuf, str, str, int, str, int, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.connect("rows-reordered", self.on_rows_reordered)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init view<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_rules_hint(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_title("Title")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_sort_column_id(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Created")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(3)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Modified")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 4)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = gdk.pixbuf_new_from_file(get_resource("images", "copy.xpm"))<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Create a new scrolled window, with scrollbars only if needed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC) #gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#print "drag"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_rows_reordered(self, treemodel, path, it, new_order):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;nrows = self.model.iter_n_children(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i in xrange(nrows):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path((i,), self.model[(i,)][6])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_page()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if page.get_title() != new_text:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename page '%s'" % page.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(paths[0])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.update()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#====================================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_nodes(self, nodes):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = nodes<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;npages = 0<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for node in nodes:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for page in node.get_pages():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;npages += 1<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if npages != 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("%d pages" % npages, "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("1 page", "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(self.model)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view_nodes(self.sel_nodes) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def _set_page(self, it, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 0, self.icon) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 1, page.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 2, page.get_created_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 3, page.get_created_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 4, page.get_modified_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 5, page.get_modified_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 6, page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path, col = self.treeview.get_cursor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def select_pages(self, pages):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = pages[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path != None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_status:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_status(text, bar=bar)<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
class TakeNoteEditor (object):<br/>
<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview = RichTextView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.add(self.textview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = sw<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if page is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.disable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.enable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.load(page.get_data_file())<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.page is not None and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.page.is_valid() and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.textview.is_modified():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.save(self.page.get_data_file())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.set_modified_time()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.on_page_modified:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified(self.page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save_needed(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.textview.is_modified()<br/>
<br/>
<br/>
class TakeNoteWindow (gtk.Window):<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_title("TakeNote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_default_size(*takenote.DEFAULT_WINDOW_SIZE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.connect("delete-event", lambda w,e: self.on_close())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# selector<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector = TakeNoteSelector()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_select_node = self.on_select_page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_status = self.set_status<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = TakeNoteTreeView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.on_select_node = self.on_select_treenode<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# editor<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor = TakeNoteEditor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.font_callback = self.on_font_change<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.on_page_modified = self.on_page_modified<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#====================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Layout<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# vertical box<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add(main_vbox)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;menubar = self.make_menubar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(menubar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# toolbar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(self.make_toolbar(), False, True, 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2 = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.set_border_width(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(main_vbox2, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#==========================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a horizontal paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned = gtk.HPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.pack_start(self.hpaned, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(takenote.DEFAULT_HSASH_POS)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a vertical paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned = gtk.VPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add2(self.vpaned)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(takenote.DEFAULT_VSASH_POS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# status bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox = gtk.HBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(status_hbox, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar = gtk.Statusbar() &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.status_bar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_property("has-resize-grip", False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_size_request(300, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar = gtk.Statusbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.stats_bar, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# layout major widgets<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add1(self.treeview.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add1(self.selector.view) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add2(self.editor.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.show_all() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if bar == "status":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif bar == "stats":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown bar '%s'" % bar)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.resize(*self.notebook.pref.window_size)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook.pref.window_pos != [-1, -1]:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.move(*self.notebook.pref.window_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(self.notebook.pref.vsash_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(self.notebook.pref.hsash_pos)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_size = self.get_size()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_pos = self.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.vsash_pos = self.vpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.hsash_pos = self.hpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_new_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("New Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_CREATE_FOLDER,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "New", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_new_notebook_response)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.rmdir(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.new_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("Open Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_OPEN,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Open", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_open_notebook_response)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*.nbk")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("Notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("All files")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def new_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.create()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Created '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Error: Could not create new notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename, new=True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename, new=False):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.load(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.get_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if not new:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Loaded '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def close_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_dir(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_dir("New Node")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_page("New Page")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed = self.notebook.save_needed() or \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.editor.save_needed()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if needed:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Notebook saved")<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_close(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""close the window and quit"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.main_quit()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return False<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_treenode(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = [node]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([])<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_page_modified(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update_node(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================================<br/>
 &nbsp; &nbsp;# Font UI Update<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_change(self, mods, justify):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# block toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_block(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_block(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_block(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update font mods<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"]) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update text justification<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_active(justify == "left")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_active(justify == "center")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_active(justify == "right") &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# unblock toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_unblock(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_unblock(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_unblock(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_bold(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_bold()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_italic(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_italic()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_underline(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_underline()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_left_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_left_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_center_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_center_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_right_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_right_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<br/>
 &nbsp; &nbsp;def on_screenshot(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.current_page == None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;f, imgfile = tempfile.mkstemp(".xpm", "takenote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.close(f)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.system("import %s" % imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(imgfile):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pixbuf = gdk.pixbuf_new_from_file(imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img = RichTextImage()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img.set_from_pixbuf(pixbuf)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.insert_image(img, "screenshot.jpg")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "error reading screenshot '%s'" % imgfile<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.remove(imgfile) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_choose_font(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.clicked()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_set(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_font_set(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_treeview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_listview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_editor(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_about(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Display about dialog"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about = gtk.AboutDialog()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_name(PROGRAM_NAME)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_version("v%s" % (PROGRAM_VERSION) )<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_copyright("Copyright Matt Rasmussen 2008")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_transient_for(self)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_position(gtk.WIN_POS_CENTER_ON_PARENT)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.connect("response", lambda d,r: about.destroy())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#================================================<br/>
 &nbsp; &nbsp;# Menubar<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_menubar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.menu_items = (<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_File", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_New Notebook",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, lambda w,e: self.on_new_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Page", &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;N", lambda w,e: self.on_new_page(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Directory", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;N", lambda w,e: self.on_new_dir(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Open Notebook", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;O", lambda w,e: self.on_open_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Save", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;S", lambda w,e: self.on_save(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Close Notebook", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;W", lambda w, e: self.close_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/Quit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Q", lambda w,e: self.on_close(), 0, None),<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Edit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Un_do", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Z", lambda w,e: self.editor.textview.undo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/_Redo", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;Z", lambda w,e: self.editor.textview.redo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Insert Screenshot",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Insert", lambda w,e: self.on_screenshot(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Format", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Left Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;L", lambda w,e: self.on_left_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/C_enter Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;E", lambda w,e: self.on_center_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Right Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;R", lambda w,e: self.on_right_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Bold", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;B", lambda w,e: self.on_bold(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Italic", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;I", lambda w,e: self.on_italic(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Underline", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;U", lambda w,e: self.on_underline(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep2", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/Choose _Font", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;F", lambda w, e: self.on_choose_font(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Go", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Tree View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;T", lambda w,e: self.on_goto_treeview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _List View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Y", lambda w,e: self.on_goto_listview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Editor",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;D", lambda w,e: self.on_goto_editor(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help", &nbsp; &nbsp; &nbsp; None, None, 0, "&lt;LastBranch&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help/About", None, lambda w,e: self.on_about(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;accel_group = gtk.AccelGroup()<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This function initializes the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 1: The type of menu - can be MenuBar, Menu,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or OptionMenu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 2: The path of the menu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 3: A reference to an AccelGroup. The item factory sets up<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the accelerator table while generating menus.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory = gtk.ItemFactory(gtk.MenuBar, "&lt;main&gt;", accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This method generates the menu items. Pass to the item factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp;the list of menu items<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory.create_items(self.menu_items)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Attach the new accelerator group to the window.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add_accel_group(accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# need to keep a reference to item_factory to prevent its destruction<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.item_factory = item_factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Finally, return the actual menu bar created by the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return item_factory.get_widget("&lt;main&gt;")<br/>
<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_toolbar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar = gtk.Toolbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_orientation(gtk.ORIENTATION_HORIZONTAL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_style(gtk.TOOLBAR_ICONS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips = gtk.Tooltips()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# bold tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "bold.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.bold_button, "Bold")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_id = self.bold_button.connect("toggled", lambda w: self.editor.textview.on_bold())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.bold_button, -1)<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# italic tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "italic.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.italic_button, "Italic")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_id = self.italic_button.connect("toggled", lambda w: self.editor.textview.on_italic())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.italic_button, -1)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# underline tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "underline.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.underline_button, "Underline")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_id = self.underline_button.connect("toggled", lambda w: self.editor.textview.on_underline())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.underline_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# font button<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel = gtk.FontButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item = gtk.ToolItem()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item.add(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(item, "Set Font")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(item, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.connect("font-set", lambda w: self.on_font_set())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# left tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignleft.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.left_button, "Left Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_id = self.left_button.connect("toggled", lambda w: self.editor.textview.on_left_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.left_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# center tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "aligncenter.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.center_button, "Center Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_id = self.center_button.connect("toggled", lambda w: self.editor.textview.on_center_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.center_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# right tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignright.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.right_button, "Right Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_id = self.right_button.connect("toggled", lambda w: self.editor.textview.on_right_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.right_button, -1) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return toolbar<br/>
<br/>
<br/>
class TakeNote (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;global BASEDIR<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;BASEDIR = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window = TakeNoteWindow(basedir)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window.open_notebook(filename)<br/>
<br/>
"""<br/>
 &nbsp; &nbsp;TakeNote<br/>
 &nbsp; &nbsp;Copyright Matt Rasmussen 2008<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;Graphical User Interface for TakeNote Application<br/>
"""<br/>
<br/>
# TODO: shade undo/redo<br/>
# TODO: add pages in treeview<br/>
# &nbsp; &nbsp; &nbsp; will eventually require lazy loading for treeview<br/>
# TODO: add framework for customized page selector columns<br/>
# TODO: add html links<br/>
# TODO: make better font selector<br/>
# TODO: add colored text<br/>
<br/>
<br/>
<br/>
# python imports<br/>
import sys, os, tempfile, re<br/>
<br/>
# pygtk imports<br/>
import pygtk<br/>
pygtk.require('2.0')<br/>
import gtk, gobject, pango<br/>
from gtk import gdk<br/>
<br/>
# takenote imports<br/>
import takenotelib as takenote<br/>
from takenotelib.undo import UndoStack<br/>
from takenotelib.richtext import RichTextView, RichTextImage<br/>
<br/>
# constants<br/>
PROGRAM_NAME = "TakeNode"<br/>
PROGRAM_VERSION = "0.1"<br/>
<br/>
DROP_YES = ("drop_yes", gtk.TARGET_SAME_WIDGET, 0)<br/>
DROP_NO = ("drop_no", gtk.TARGET_SAME_WIDGET, 0)<br/>
<br/>
<br/>
BASEDIR = ""<br/>
def get_resource(*path_list):<br/>
 &nbsp; &nbsp;return os.path.join(BASEDIR, *path_list)<br/>
<br/>
<br/>
def compute_new_path(model, target, drop_position):<br/>
 &nbsp; &nbsp;path = model.get_path(target)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER: &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path + (0,) #model.get_n_children(target),)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path[:-1] + (path[-1] + 1,)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
<br/>
def copy_row(treeview, model, source, target, drop_position):<br/>
<br/>
 &nbsp; &nbsp;# move source row<br/>
 &nbsp; &nbsp;source_row = model[source]<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.prepend(target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_before(None, target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_after(None, target, source_row)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
 &nbsp; &nbsp;# recursively move children<br/>
 &nbsp; &nbsp;for n in range(model.iter_n_children(source)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;child = model.iter_nth_child(source, n)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, child, new,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gtk.TREE_VIEW_DROP_INTO_OR_BEFORE)<br/>
<br/>
 &nbsp; &nbsp;# expand view to keep the same expansion pattern<br/>
 &nbsp; &nbsp;source_is_expanded = treeview.row_expanded(model.get_path(source))<br/>
 &nbsp; &nbsp;new_path = model.get_path(new)<br/>
 &nbsp; &nbsp;if source_is_expanded:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_to_path(new_path)<br/>
<br/>
 &nbsp; &nbsp;return new_path<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
class DataMap (object):<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path = {}<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data = {}<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_path(self, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.data2path.get(data, None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_data(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if isinstance(path, str):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = str2path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data.get(path, None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;assert data is not None, path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path_all(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively remove path and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for child in get_child_data(data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child_path = self.get_path(child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if child_path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.remove_path_all(child_path, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path(self, path, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path_all(self, path, data, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively add paths for data and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_path_all(path + (i,), child, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def clear_path(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data.clear()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def assert_path(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path2 = path + (i,)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child2 = self.get_data(path2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;assert child2 == child<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.assert_path(path2, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
def str2path(pathtext):<br/>
 &nbsp; &nbsp;"""Converts str to tuple path"""<br/>
 &nbsp; &nbsp;# sometime GTK returns a str instead of a tuple for a path... weird<br/>
 &nbsp; &nbsp;return tuple(map(int, pathtext.split(":")))<br/>
<br/>
<br/>
def dnd_sanity_check(source_path, target_path):<br/>
 &nbsp; &nbsp;"""The target cannot be a descendant of the source<br/>
 &nbsp; &nbsp; &nbsp; i.e. You cannot become your descendent's child<br/>
 &nbsp; &nbsp; &nbsp; i.e. The source path cannot be a prefix of the target path"""<br/>
 &nbsp; &nbsp;return source_path != target_path[:len(source_path)]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
<br/>
class TakeNoteTreeView (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a TreeStore with one string column to use as the model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.TreeStore(gdk.Pixbuf, str, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.expanded_id = self.treeview.connect("row-expanded", self.on_row_expanded)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.collapsed_id = self.treeview.connect("row-collapsed", self.on_row_collapsed) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-data-received", self.on_drag_data_received)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.get_selection().set_mode(gtk.SELECTION_MULTIPLE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_headers_visible(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_property("enable-tree-lines", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# make treeview searchable<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_search_column(1) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_reorderable(True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True) &nbsp; &nbsp; &nbsp; <br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create the treeview column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_clickable(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a cell renderers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# add the cells to column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in treestore<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = pixbuf = gdk.pixbuf_new_from_file(get_resource("images", "open.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_drag_data_received(self, treeview, drag_context, x, y,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;selection_data, info, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target = model.get_iter(target_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drop is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(source_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record old and new parent paths<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = source_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_path = compute_new_path(self.model, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent_path = new_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent = self.datamap.get_data(new_parent_path)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# remove obsolete model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(new_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(old_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in notebook model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.move(new_parent, new_path[-1])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in tree model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, source, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record new model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(new_parent_path, new_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path2 = self.datamap.get_path(old_parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent_path2 is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = old_parent_path2<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(old_parent_path, old_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# DEBUG: assert that all mappings are correct<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.assert_path((0,), lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# make sure to show new children<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_row(target_path, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(True, True, eventtime)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(False, False, eventtime)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def drop_allowed(self, source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Determine if drop is allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return dnd_sanity_check(source_path, target_path) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not (target_path == (0,) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(drop_position == gtk.TREE_VIEW_DROP_BEFORE or <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_AFTER))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_row_expanded(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(True)<br/>
<br/>
 &nbsp; &nbsp;def on_row_collapsed(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(False)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename '%s'" % node.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(self.datamap.get_data(paths[0]))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_node(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if parent is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# warn<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "Cannot delete notebook's toplevel directory"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#==============================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;root = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(None, root)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def expand_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_node(self, parent, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append(parent, [self.icon, node.get_title(), node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node.is_expanded():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(self.datamap.get_path(node))<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;expanded = self.treeview.row_expanded(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in self.model[path].iterchildren():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(child.path, lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.remove(child.iter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
class SelectorColumn (object):<br/>
 &nbsp; &nbsp;def __init__(self, name, kind, col):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.name = name<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.kind = kind<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.col = col<br/>
<br/>
TITLE_COLUMN = SelectorColumn("Title", str, 0)<br/>
CREATED_COLUMN = SelectorColumn("Created", str, 1)<br/>
MODIFIED_COLUMN = SelectorColumn("Modified", str, 2)<br/>
<br/>
<br/>
class TakeNoteSelector (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_status = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.display_columns = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.ListStore(gdk.Pixbuf, str, str, int, str, int, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.connect("rows-reordered", self.on_rows_reordered)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init view<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_rules_hint(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_title("Title")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_sort_column_id(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Created")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(3)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Modified")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 4)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = gdk.pixbuf_new_from_file(get_resource("images", "copy.xpm"))<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Create a new scrolled window, with scrollbars only if needed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC) #gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#print "drag"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_rows_reordered(self, treemodel, path, it, new_order):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;nrows = self.model.iter_n_children(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i in xrange(nrows):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path((i,), self.model[(i,)][6])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_page()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if page.get_title() != new_text:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename page '%s'" % page.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(paths[0])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.update()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#====================================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_nodes(self, nodes):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = nodes<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;npages = 0<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for node in nodes:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for page in node.get_pages():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;npages += 1<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if npages != 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("%d pages" % npages, "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("1 page", "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(self.model)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view_nodes(self.sel_nodes) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def _set_page(self, it, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 0, self.icon) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 1, page.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 2, page.get_created_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 3, page.get_created_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 4, page.get_modified_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 5, page.get_modified_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 6, page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path, col = self.treeview.get_cursor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def select_pages(self, pages):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = pages[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path != None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_status:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_status(text, bar=bar)<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
class TakeNoteEditor (object):<br/>
<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview = RichTextView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.add(self.textview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = sw<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if page is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.disable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.enable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.load(page.get_data_file())<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.page is not None and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.page.is_valid() and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.textview.is_modified():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.save(self.page.get_data_file())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.set_modified_time()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.on_page_modified:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified(self.page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save_needed(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.textview.is_modified()<br/>
<br/>
<br/>
class TakeNoteWindow (gtk.Window):<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_title("TakeNote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_default_size(*takenote.DEFAULT_WINDOW_SIZE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.connect("delete-event", lambda w,e: self.on_close())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# selector<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector = TakeNoteSelector()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_select_node = self.on_select_page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_status = self.set_status<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = TakeNoteTreeView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.on_select_node = self.on_select_treenode<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# editor<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor = TakeNoteEditor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.font_callback = self.on_font_change<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.on_page_modified = self.on_page_modified<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#====================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Layout<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# vertical box<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add(main_vbox)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;menubar = self.make_menubar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(menubar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# toolbar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(self.make_toolbar(), False, True, 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2 = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.set_border_width(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(main_vbox2, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#==========================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a horizontal paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned = gtk.HPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.pack_start(self.hpaned, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(takenote.DEFAULT_HSASH_POS)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a vertical paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned = gtk.VPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add2(self.vpaned)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(takenote.DEFAULT_VSASH_POS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# status bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox = gtk.HBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(status_hbox, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar = gtk.Statusbar() &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.status_bar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_property("has-resize-grip", False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_size_request(300, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar = gtk.Statusbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.stats_bar, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# layout major widgets<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add1(self.treeview.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add1(self.selector.view) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add2(self.editor.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.show_all() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if bar == "status":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif bar == "stats":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown bar '%s'" % bar)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.resize(*self.notebook.pref.window_size)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook.pref.window_pos != [-1, -1]:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.move(*self.notebook.pref.window_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(self.notebook.pref.vsash_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(self.notebook.pref.hsash_pos)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_size = self.get_size()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_pos = self.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.vsash_pos = self.vpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.hsash_pos = self.hpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_new_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("New Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_CREATE_FOLDER,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "New", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_new_notebook_response)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.rmdir(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.new_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("Open Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_OPEN,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Open", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_open_notebook_response)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*.nbk")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("Notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("All files")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def new_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.create()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Created '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Error: Could not create new notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename, new=True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename, new=False):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.load(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.get_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if not new:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Loaded '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def close_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_dir(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_dir("New Node")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_page("New Page")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed = self.notebook.save_needed() or \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.editor.save_needed()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if needed:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Notebook saved")<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_close(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""close the window and quit"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.main_quit()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return False<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_treenode(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = [node]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([])<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_page_modified(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update_node(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================================<br/>
 &nbsp; &nbsp;# Font UI Update<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_change(self, mods, justify):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# block toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_block(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_block(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_block(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update font mods<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"]) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update text justification<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_active(justify == "left")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_active(justify == "center")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_active(justify == "right") &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# unblock toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_unblock(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_unblock(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_unblock(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_bold(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_bold()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_italic(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_italic()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_underline(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_underline()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<b><i><u> &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_left_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_left_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_center_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_center_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_right_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_right_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<br/>
 &nbsp; &nbsp;def on_screenshot(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.current_page == None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;f, imgfile = tempfile.mkstemp(".xpm", "takenote")</u></i></b><br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.close(f)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.system("import %s" % imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(imgfile):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pixbuf = gdk.pixbuf_new_from_file(imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img = RichTextImage()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img.set_from_pixbuf(pixbuf)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.insert_image(img, "screenshot.jpg")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "error reading screenshot '%s'" % imgfile<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.remove(imgfile) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_choose_font(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.clicked()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_set(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_font_set(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_treeview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_listview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_editor(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_about(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Display about dialog"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<b> &nbsp; &nbsp; &nbsp; &nbsp;about = gtk.AboutDialog()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_name(PROGRAM_NAME)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_version("v%s" % (PROGRAM_VERSION) )<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_copyright("Copyright Matt Rasmussen 2008")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_transient_for(self)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_position(gtk.WIN_POS_CENTER_ON_PARENT)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.connect("response", lambda d,r: about.destroy())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#================================================<br/>
 &nbsp; &nbsp;# Menubar<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_menubar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.menu_items = (<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_File", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_New Notebook",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, lambda w,e: self.on_new_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Page", &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;N", lambda w,e: self.on_new_page(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Directory", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;N", lambda w,e: self.on_new_dir(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Open Notebook", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;O", lambda w,e: self.on_open_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Save", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;S", lambda w,e: self.on_save(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Close Notebook", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;W", lambda w, e: self.close_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/Quit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Q", lambda w,e: self.on_close(), 0, None),</b><br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Edit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Un_do", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Z", lambda w,e: self.editor.textview.undo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/_Redo", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;Z", lambda w,e: self.editor.textview.redo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Insert Screenshot",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Insert", lambda w,e: self.on_screenshot(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<b>("/_Format", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Left Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;L", lambda w,e: self.on_left_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/C_enter Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;E", lambda w,e: self.on_center_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Right Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;R", lambda w,e: self.on_right_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Bold", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;B", lambda w,e: self.on_bold(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Italic", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;I", lambda w,e: self.on_italic(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Underline", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;U", lambda w,e: self.on_underline(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep2", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/Choose _Font", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;F", lambda w, e: self.on_choose_font(), 0, None),</b><br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Go", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Tree View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;T", lambda w,e: self.on_goto_treeview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _List View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Y", lambda w,e: self.on_goto_listview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Editor",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;D", lambda w,e: self.on_goto_editor(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help", &nbsp; &nbsp; &nbsp; None, None, 0, "&lt;LastBranch&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help/About", None, lambda w,e: self.on_about(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;accel_group = gtk.AccelGroup()<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This function initializes the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 1: The type of menu - can be MenuBar, Menu,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or OptionMenu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 2: The path of the menu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 3: A reference to an AccelGroup. The item factory sets up<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the accelerator table while generating menus.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory = gtk.ItemFactory(gtk.MenuBar, "&lt;main&gt;", accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This method generates the menu items. Pass to the item factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp;the list of menu items<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory.create_items(self.menu_items)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Attach the new accelerator group to the window.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add_accel_group(accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# need to keep a reference to item_factory to prevent its destruction<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.item_factory = item_factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Finally, return the actual menu bar created by the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return item_factory.get_widget("&lt;main&gt;")<br/>
<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_toolbar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar = gtk.Toolbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_orientation(gtk.ORIENTATION_HORIZONTAL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_style(gtk.TOOLBAR_ICONS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips = gtk.Tooltips()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# bold tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "bold.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.bold_button, "Bold")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_id = self.bold_button.connect("toggled", lambda w: self.editor.textview.on_bold())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.bold_button, -1)<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# italic tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "italic.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.italic_button, "Italic")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_id = self.italic_button.connect("toggled", lambda w: self.editor.textview.on_italic())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.italic_button, -1)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# underline tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "underline.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.underline_button, "Underline")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_id = self.underline_button.connect("toggled", lambda w: self.editor.textview.on_underline())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.underline_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# font button<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel = gtk.FontButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item = gtk.ToolItem()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item.add(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(item, "Set Font")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(item, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.connect("font-set", lambda w: self.on_font_set())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# left tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignleft.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.left_button, "Left Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_id = self.left_button.connect("toggled", lambda w: self.editor.textview.on_left_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.left_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# center tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "aligncenter.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.center_button, "Center Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_id = self.center_button.connect("toggled", lambda w: self.editor.textview.on_center_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.center_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# right tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignright.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.right_button, "Right Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_id = self.right_button.connect("toggled", lambda w: self.editor.textview.on_right_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.right_button, -1) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return toolbar<br/>
<br/>
<br/>
class TakeNote (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;global BASEDIR<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;BASEDIR = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window = TakeNoteWindow(basedir)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window.open_notebook(filename)<br/>
<br/>
"""<br/>
 &nbsp; &nbsp;TakeNote<br/>
 &nbsp; &nbsp;Copyright Matt Rasmussen 2008<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;Graphical User Interface for TakeNote Application<br/>
"""<br/>
<br/>
# TODO: shade undo/redo<br/>
# TODO: add pages in treeview<br/>
# &nbsp; &nbsp; &nbsp; will eventually require lazy loading for treeview<br/>
# TODO: add framework for customized page selector columns<br/>
# TODO: add html links<br/>
# TODO: make better font selector<br/>
# TODO: add colored text<br/>
<br/>
<br/>
<br/>
# python imports<br/>
import sys, os, tempfile, re<br/>
<br/>
# pygtk imports<br/>
import pygtk<br/>
pygtk.require('2.0')<br/>
import gtk, gobject, pango<br/>
from gtk import gdk<br/>
<br/>
# takenote imports<br/>
import takenotelib as takenote<br/>
from takenotelib.undo import UndoStack<br/>
from takenotelib.richtext import RichTextView, RichTextImage<br/>
<br/>
# constants<br/>
PROGRAM_NAME = "TakeNode"<br/>
PROGRAM_VERSION = "0.1"<br/>
<br/>
DROP_YES = ("drop_yes", gtk.TARGET_SAME_WIDGET, 0)<br/>
DROP_NO = ("drop_no", gtk.TARGET_SAME_WIDGET, 0)<br/>
<br/>
<br/>
BASEDIR = ""<br/>
def get_resource(*path_list):<br/>
 &nbsp; &nbsp;return os.path.join(BASEDIR, *path_list)<br/>
<br/>
<br/>
def compute_new_path(model, target, drop_position):<br/>
 &nbsp; &nbsp;path = model.get_path(target)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER: &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path + (0,) #model.get_n_children(target),)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;root = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(None, root)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def expand_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_node(self, parent, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append(parent, [self.icon, node.get_title(), node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node.is_expanded():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(self.datamap.get_path(node))<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;expanded = self.treeview.row_expanded(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in self.model[path].iterchildren():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(child.path, lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.remove(child.iter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
class SelectorColumn (object):<br/>
 &nbsp; &nbsp;def __init__(self, name, kind, col):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.name = name<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.kind = kind<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.col = col<br/>
<br/>
TITLE_COLUMN = SelectorColumn("Title", str, 0)<br/>
CREATED_COLUMN = SelectorColumn("Created", str, 1)<br/>
MODIFIED_COLUMN = SelectorColumn("Modified", str, 2)<br/>
<br/>
<br/>
class TakeNoteSelector (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_status = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.display_columns = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.ListStore(gdk.Pixbuf, str, str, int, str, int, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.connect("rows-reordered", self.on_rows_reordered)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init view<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_rules_hint(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_title("Title")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_sort_column_id(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Created")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(3)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Modified")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 4)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = gdk.pixbuf_new_from_file(get_resource("images", "copy.xpm"))<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Create a new scrolled window, with scrollbars only if needed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC) #gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#print "drag"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_rows_reordered(self, treemodel, path, it, new_order):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;nrows = self.model.iter_n_children(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i in xrange(nrows):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path((i,), self.model[(i,)][6])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_page()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if page.get_title() != new_text:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename page '%s'" % page.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(paths[0])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.update()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#====================================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_nodes(self, nodes):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = nodes<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;npages = 0<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for node in nodes:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for page in node.get_pages():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;npages += 1<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if npages != 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("%d pages" % npages, "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("1 page", "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(self.model)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view_nodes(self.sel_nodes) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def _set_page(self, it, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 0, self.icon) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 1, page.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 2, page.get_created_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 3, page.get_created_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 4, page.get_modified_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 5, page.get_modified_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 6, page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path, col = self.treeview.get_cursor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def select_pages(self, pages):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = pages[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path != None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_status:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_status(text, bar=bar)<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
class TakeNoteEditor (object):<br/>
<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview = RichTextView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.add(self.textview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = sw<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if page is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.disable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.enable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.load(page.get_data_file())<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.page is not None and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.page.is_valid() and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.textview.is_modified():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.save(self.page.get_data_file())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.set_modified_time()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.on_page_modified:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified(self.page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save_needed(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.textview.is_modified()<br/>
<br/>
<br/>
class TakeNoteWindow (gtk.Window):<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_title("TakeNote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_default_size(*takenote.DEFAULT_WINDOW_SIZE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.connect("delete-event", lambda w,e: self.on_close())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# selector<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector = TakeNoteSelector()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_select_node = self.on_select_page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_status = self.set_status<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = TakeNoteTreeView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.on_select_node = self.on_select_treenode<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# editor<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor = TakeNoteEditor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.font_callback = self.on_font_change<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.on_page_modified = self.on_page_modified<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#====================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Layout<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# vertical box<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add(main_vbox)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;menubar = self.make_menubar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(menubar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# toolbar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(self.make_toolbar(), False, True, 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2 = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.set_border_width(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(main_vbox2, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#==========================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a horizontal paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned = gtk.HPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.pack_start(self.hpaned, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(takenote.DEFAULT_HSASH_POS)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a vertical paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned = gtk.VPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add2(self.vpaned)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(takenote.DEFAULT_VSASH_POS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# status bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox = gtk.HBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(status_hbox, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar = gtk.Statusbar() &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.status_bar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_property("has-resize-grip", False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_size_request(300, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar = gtk.Statusbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.stats_bar, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# layout major widgets<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add1(self.treeview.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add1(self.selector.view) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add2(self.editor.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.show_all() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if bar == "status":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif bar == "stats":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown bar '%s'" % bar)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.resize(*self.notebook.pref.window_size)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook.pref.window_pos != [-1, -1]:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.move(*self.notebook.pref.window_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(self.notebook.pref.vsash_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(self.notebook.pref.hsash_pos)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_size = self.get_size()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_pos = self.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.vsash_pos = self.vpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.hsash_pos = self.hpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_new_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("New Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_CREATE_FOLDER,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "New", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_new_notebook_response)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.rmdir(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.new_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("Open Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_OPEN,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Open", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_open_notebook_response)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*.nbk")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("Notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("All files")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def new_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.create()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Created '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Error: Could not create new notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename, new=True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename, new=False):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.load(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.get_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if not new:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Loaded '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def close_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_dir(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_dir("New Node")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_page("New Page")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed = self.notebook.save_needed() or \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.editor.save_needed()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if needed:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Notebook saved")<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_close(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""close the window and quit"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.main_quit()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return False<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_treenode(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = [node]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([])<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_page_modified(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update_node(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================================<br/>
 &nbsp; &nbsp;# Font UI Update<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_change(self, mods, justify):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# block toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_block(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_block(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_block(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update font mods<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"]) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update text justification<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_active(justify == "left")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_active(justify == "center")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_active(justify == "right") &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# unblock toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_unblock(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_unblock(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_unblock(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_bold(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_bold()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_italic(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_italic()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_underline(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_underline()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_left_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_left_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_center_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_center_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_right_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_right_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<br/>
 &nbsp; &nbsp;def on_screenshot(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.current_page == None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;f, imgfile = tempfile.mkstemp(".xpm", "takenote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.close(f)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.system("import %s" % imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(imgfile):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pixbuf = gdk.pixbuf_new_from_file(imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img = RichTextImage()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img.set_from_pixbuf(pixbuf)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.insert_image(img, "screenshot.jpg")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "error reading screenshot '%s'" % imgfile<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.remove(imgfile) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_choose_font(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.clicked()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_set(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_font_set(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_treeview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_listview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_editor(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_about(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Display about dialog"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about = gtk.AboutDialog()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_name(PROGRAM_NAME)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_version("v%s" % (PROGRAM_VERSION) )<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_copyright("Copyright Matt Rasmussen 2008")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_transient_for(self)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_position(gtk.WIN_POS_CENTER_ON_PARENT)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.connect("response", lambda d,r: about.destroy())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#================================================<br/>
 &nbsp; &nbsp;# Menubar<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_menubar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.menu_items = (<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_File", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_New Notebook",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, lambda w,e: self.on_new_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Page", &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;N", lambda w,e: self.on_new_page(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Directory", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;N", lambda w,e: self.on_new_dir(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Open Notebook", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;O", lambda w,e: self.on_open_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Save", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;S", lambda w,e: self.on_save(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Close Notebook", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;W", lambda w, e: self.close_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/Quit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Q", lambda w,e: self.on_close(), 0, None),<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Edit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Un_do", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Z", lambda w,e: self.editor.textview.undo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/_Redo", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;Z", lambda w,e: self.editor.textview.redo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Insert Screenshot",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Insert", lambda w,e: self.on_screenshot(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Format", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Left Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;L", lambda w,e: self.on_left_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/C_enter Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;E", lambda w,e: self.on_center_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Right Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;R", lambda w,e: self.on_right_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Bold", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;B", lambda w,e: self.on_bold(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Italic", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;I", lambda w,e: self.on_italic(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Underline", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;U", lambda w,e: self.on_underline(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep2", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/Choose _Font", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;F", lambda w, e: self.on_choose_font(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Go", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Tree View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;T", lambda w,e: self.on_goto_treeview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _List View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Y", lambda w,e: self.on_goto_listview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Editor",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;D", lambda w,e: self.on_goto_editor(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help", &nbsp; &nbsp; &nbsp; None, None, 0, "&lt;LastBranch&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help/About", None, lambda w,e: self.on_about(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;accel_group = gtk.AccelGroup()<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This function initializes the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 1: The type of menu - can be MenuBar, Menu,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or OptionMenu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 2: The path of the menu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 3: A reference to an AccelGroup. The item factory sets up<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the accelerator table while generating menus.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory = gtk.ItemFactory(gtk.MenuBar, "&lt;main&gt;", accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This method generates the menu items. Pass to the item factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp;the list of menu items<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory.create_items(self.menu_items)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Attach the new accelerator group to the window.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add_accel_group(accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# need to keep a reference to item_factory to prevent its destruction<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.item_factory = item_factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Finally, return the actual menu bar created by the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return item_factory.get_widget("&lt;main&gt;")<br/>
<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_toolbar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar = gtk.Toolbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_orientation(gtk.ORIENTATION_HORIZONTAL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_style(gtk.TOOLBAR_ICONS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips = gtk.Tooltips()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# bold tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "bold.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.bold_button, "Bold")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_id = self.bold_button.connect("toggled", lambda w: self.editor.textview.on_bold())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.bold_button, -1)<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# italic tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "italic.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.italic_button, "Italic")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_id = self.italic_button.connect("toggled", lambda w: self.editor.textview.on_italic())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.italic_button, -1)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# underline tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "underline.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.underline_button, "Underline")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_id = self.underline_button.connect("toggled", lambda w: self.editor.textview.on_underline())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.underline_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# font button<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel = gtk.FontButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item = gtk.ToolItem()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item.add(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(item, "Set Font")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(item, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.connect("font-set", lambda w: self.on_font_set())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# left tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignleft.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.left_button, "Left Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_id = self.left_button.connect("toggled", lambda w: self.editor.textview.on_left_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.left_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# center tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "aligncenter.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.center_button, "Center Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_id = self.center_button.connect("toggled", lambda w: self.editor.textview.on_center_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.center_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# right tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignright.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.right_button, "Right Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_id = self.right_button.connect("toggled", lambda w: self.editor.textview.on_right_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.right_button, -1) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return toolbar<br/>
<br/>
<br/>
class TakeNote (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;global BASEDIR<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;BASEDIR = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window = TakeNoteWindow(basedir)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window.open_notebook(filename)<br/>
<br/>
"""<br/>
 &nbsp; &nbsp;TakeNote<br/>
 &nbsp; &nbsp;Copyright Matt Rasmussen 2008<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;Graphical User Interface for TakeNote Application<br/>
"""<br/>
<br/>
# TODO: shade undo/redo<br/>
# TODO: add pages in treeview<br/>
# &nbsp; &nbsp; &nbsp; will eventually require lazy loading for treeview<br/>
# TODO: add framework for customized page selector columns<br/>
# TODO: add html links<br/>
# TODO: make better font selector<br/>
# TODO: add colored text<br/>
<br/>
<br/>
<br/>
# python imports<br/>
import sys, os, tempfile, re<br/>
<br/>
# pygtk imports<br/>
import pygtk<br/>
pygtk.require('2.0')<br/>
import gtk, gobject, pango<br/>
from gtk import gdk<br/>
<br/>
# takenote imports<br/>
import takenotelib as takenote<br/>
from takenotelib.undo import UndoStack<br/>
from takenotelib.richtext import RichTextView, RichTextImage<br/>
<br/>
# constants<br/>
PROGRAM_NAME = "TakeNode"<br/>
PROGRAM_VERSION = "0.1"<br/>
<br/>
DROP_YES = ("drop_yes", gtk.TARGET_SAME_WIDGET, 0)<br/>
DROP_NO = ("drop_no", gtk.TARGET_SAME_WIDGET, 0)<br/>
<br/>
<br/>
BASEDIR = ""<br/>
def get_resource(*path_list):<br/>
 &nbsp; &nbsp;return os.path.join(BASEDIR, *path_list)<br/>
<br/>
<br/>
def compute_new_path(model, target, drop_position):<br/>
 &nbsp; &nbsp;path = model.get_path(target)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER: &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path + (0,) #model.get_n_children(target),)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path[:-1] + (path[-1] + 1,)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
<br/>
def copy_row(treeview, model, source, target, drop_position):<br/>
<br/>
 &nbsp; &nbsp;# move source row<br/>
 &nbsp; &nbsp;source_row = model[source]<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.prepend(target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_before(None, target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_after(None, target, source_row)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
 &nbsp; &nbsp;# recursively move children<br/>
 &nbsp; &nbsp;for n in range(model.iter_n_children(source)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;child = model.iter_nth_child(source, n)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, child, new,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gtk.TREE_VIEW_DROP_INTO_OR_BEFORE)<br/>
<br/>
 &nbsp; &nbsp;# expand view to keep the same expansion pattern<br/>
 &nbsp; &nbsp;source_is_expanded = treeview.row_expanded(model.get_path(source))<br/>
 &nbsp; &nbsp;new_path = model.get_path(new)<br/>
 &nbsp; &nbsp;if source_is_expanded:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_to_path(new_path)<br/>
<br/>
 &nbsp; &nbsp;return new_path<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
class DataMap (object):<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path = {}<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data = {}<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_path(self, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.data2path.get(data, None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_data(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if isinstance(path, str):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = str2path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data.get(path, None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;assert data is not None, path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path_all(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively remove path and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for child in get_child_data(data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child_path = self.get_path(child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if child_path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.remove_path_all(child_path, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path(self, path, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path_all(self, path, data, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively add paths for data and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_path_all(path + (i,), child, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def clear_path(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data.clear()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def assert_path(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path2 = path + (i,)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child2 = self.get_data(path2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;assert child2 == child<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.assert_path(path2, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
def str2path(pathtext):<br/>
 &nbsp; &nbsp;"""Converts str to tuple path"""<br/>
 &nbsp; &nbsp;# sometime GTK returns a str instead of a tuple for a path... weird<br/>
 &nbsp; &nbsp;return tuple(map(int, pathtext.split(":")))<br/>
<br/>
<br/>
def dnd_sanity_check(source_path, target_path):<br/>
 &nbsp; &nbsp;"""The target cannot be a descendant of the source<br/>
 &nbsp; &nbsp; &nbsp; i.e. You cannot become your descendent's child<br/>
 &nbsp; &nbsp; &nbsp; i.e. The source path cannot be a prefix of the target path"""<br/>
 &nbsp; &nbsp;return source_path != target_path[:len(source_path)]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
<br/>
class TakeNoteTreeView (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a TreeStore with one string column to use as the model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.TreeStore(gdk.Pixbuf, str, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.expanded_id = self.treeview.connect("row-expanded", self.on_row_expanded)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.collapsed_id = self.treeview.connect("row-collapsed", self.on_row_collapsed) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-data-received", self.on_drag_data_received)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.get_selection().set_mode(gtk.SELECTION_MULTIPLE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_headers_visible(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_property("enable-tree-lines", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# make treeview searchable<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_search_column(1) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_reorderable(True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True) &nbsp; &nbsp; &nbsp; <br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create the treeview column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_clickable(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a cell renderers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# add the cells to column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in treestore<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = pixbuf = gdk.pixbuf_new_from_file(get_resource("images", "open.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_drag_data_received(self, treeview, drag_context, x, y,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;selection_data, info, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target = model.get_iter(target_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drop is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(source_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record old and new parent paths<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = source_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_path = compute_new_path(self.model, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent_path = new_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent = self.datamap.get_data(new_parent_path)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# remove obsolete model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(new_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(old_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in notebook model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.move(new_parent, new_path[-1])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in tree model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, source, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record new model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(new_parent_path, new_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path2 = self.datamap.get_path(old_parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent_path2 is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = old_parent_path2<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(old_parent_path, old_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# DEBUG: assert that all mappings are correct<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.assert_path((0,), lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# make sure to show new children<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_row(target_path, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(True, True, eventtime)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(False, False, eventtime)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def drop_allowed(self, source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Determine if drop is allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return dnd_sanity_check(source_path, target_path) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not (target_path == (0,) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(drop_position == gtk.TREE_VIEW_DROP_BEFORE or <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_AFTER))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_row_expanded(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(True)<br/>
<br/>
 &nbsp; &nbsp;def on_row_collapsed(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(False)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename '%s'" % node.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(self.datamap.get_data(paths[0]))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_node(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if parent is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# warn<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "Cannot delete notebook's toplevel directory"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#==============================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;root = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(None, root)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def expand_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_node(self, parent, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append(parent, [self.icon, node.get_title(), node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node.is_expanded():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(self.datamap.get_path(node))<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;expanded = self.treeview.row_expanded(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in self.model[path].iterchildren():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(child.path, lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.remove(child.iter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
class SelectorColumn (object):<br/>
 &nbsp; &nbsp;def __init__(self, name, kind, col):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.name = name<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.kind = kind<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.col = col<br/>
<br/>
TITLE_COLUMN = SelectorColumn("Title", str, 0)<br/>
CREATED_COLUMN = SelectorColumn("Created", str, 1)<br/>
MODIFIED_COLUMN = SelectorColumn("Modified", str, 2)<br/>
<br/>
<br/>
class TakeNoteSelector (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_status = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.display_columns = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.ListStore(gdk.Pixbuf, str, str, int, str, int, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.connect("rows-reordered", self.on_rows_reordered)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init view<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_rules_hint(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_title("Title")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_sort_column_id(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Created")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(3)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Modified")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 4)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = gdk.pixbuf_new_from_file(get_resource("images", "copy.xpm"))<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Create a new scrolled window, with scrollbars only if needed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC) #gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#print "drag"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_rows_reordered(self, treemodel, path, it, new_order):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;nrows = self.model.iter_n_children(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i in xrange(nrows):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path((i,), self.model[(i,)][6])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_page()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if page.get_title() != new_text:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename page '%s'" % page.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(paths[0])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.update()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#====================================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_nodes(self, nodes):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = nodes<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;npages = 0<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for node in nodes:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for page in node.get_pages():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;npages += 1<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if npages != 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("%d pages" % npages, "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("1 page", "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(self.model)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view_nodes(self.sel_nodes) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def _set_page(self, it, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 0, self.icon) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 1, page.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 2, page.get_created_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 3, page.get_created_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 4, page.get_modified_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 5, page.get_modified_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 6, page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path, col = self.treeview.get_cursor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def select_pages(self, pages):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = pages[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path != None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_status:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_status(text, bar=bar)<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
class TakeNoteEditor (object):<br/>
<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview = RichTextView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.add(self.textview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = sw<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if page is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.disable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.enable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.load(page.get_data_file())<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.page is not None and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.page.is_valid() and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.textview.is_modified():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.save(self.page.get_data_file())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.set_modified_time()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.on_page_modified:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified(self.page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save_needed(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.textview.is_modified()<br/>
<br/>
<br/>
class TakeNoteWindow (gtk.Window):<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_title("TakeNote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_default_size(*takenote.DEFAULT_WINDOW_SIZE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.connect("delete-event", lambda w,e: self.on_close())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# selector<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector = TakeNoteSelector()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_select_node = self.on_select_page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_status = self.set_status<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = TakeNoteTreeView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.on_select_node = self.on_select_treenode<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# editor<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor = TakeNoteEditor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.font_callback = self.on_font_change<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.on_page_modified = self.on_page_modified<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#====================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Layout<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# vertical box<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add(main_vbox)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;menubar = self.make_menubar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(menubar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# toolbar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(self.make_toolbar(), False, True, 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2 = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.set_border_width(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(main_vbox2, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#==========================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a horizontal paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned = gtk.HPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.pack_start(self.hpaned, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(takenote.DEFAULT_HSASH_POS)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a vertical paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned = gtk.VPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add2(self.vpaned)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(takenote.DEFAULT_VSASH_POS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# status bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox = gtk.HBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(status_hbox, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar = gtk.Statusbar() &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.status_bar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_property("has-resize-grip", False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_size_request(300, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar = gtk.Statusbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.stats_bar, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# layout major widgets<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add1(self.treeview.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add1(self.selector.view) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add2(self.editor.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.show_all() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if bar == "status":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif bar == "stats":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown bar '%s'" % bar)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.resize(*self.notebook.pref.window_size)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook.pref.window_pos != [-1, -1]:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.move(*self.notebook.pref.window_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(self.notebook.pref.vsash_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(self.notebook.pref.hsash_pos)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_size = self.get_size()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_pos = self.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.vsash_pos = self.vpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.hsash_pos = self.hpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_new_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("New Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_CREATE_FOLDER,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "New", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_new_notebook_response)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.rmdir(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.new_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("Open Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_OPEN,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Open", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_open_notebook_response)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*.nbk")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("Notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("All files")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def new_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.create()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Created '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Error: Could not create new notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename, new=True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename, new=False):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.load(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.get_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if not new:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Loaded '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def close_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_dir(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_dir("New Node")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_page("New Page")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed = self.notebook.save_needed() or \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.editor.save_needed()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if needed:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Notebook saved")<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_close(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""close the window and quit"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.main_quit()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return False<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_treenode(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = [node]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([])<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_page_modified(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update_node(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================================<br/>
 &nbsp; &nbsp;# Font UI Update<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_change(self, mods, justify):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# block toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_block(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_block(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_block(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update font mods<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"]) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update text justification<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_active(justify == "left")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_active(justify == "center")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_active(justify == "right") &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# unblock toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_unblock(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_unblock(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_unblock(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_bold(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_bold()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_italic(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_italic()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_underline(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_underline()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_left_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_left_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_center_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_center_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_right_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_right_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<br/>
 &nbsp; &nbsp;def on_screenshot(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.current_page == None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;f, imgfile = tempfile.mkstemp(".xpm", "takenote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.close(f)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.system("import %s" % imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(imgfile):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pixbuf = gdk.pixbuf_new_from_file(imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img = RichTextImage()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img.set_from_pixbuf(pixbuf)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.insert_image(img, "screenshot.jpg")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "error reading screenshot '%s'" % imgfile<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.remove(imgfile) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_choose_font(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.clicked()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_set(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_font_set(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_treeview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_listview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_editor(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_about(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Display about dialog"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about = gtk.AboutDialog()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_name(PROGRAM_NAME)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_version("v%s" % (PROGRAM_VERSION) )<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_copyright("Copyright Matt Rasmussen 2008")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_transient_for(self)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_position(gtk.WIN_POS_CENTER_ON_PARENT)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.connect("response", lambda d,r: about.destroy())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#================================================<br/>
 &nbsp; &nbsp;# Menubar<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_menubar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.menu_items = (<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_File", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_New Notebook",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, lambda w,e: self.on_new_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Page", &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;N", lambda w,e: self.on_new_page(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Directory", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;N", lambda w,e: self.on_new_dir(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Open Notebook", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;O", lambda w,e: self.on_open_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Save", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;S", lambda w,e: self.on_save(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Close Notebook", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;W", lambda w, e: self.close_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/Quit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Q", lambda w,e: self.on_close(), 0, None),<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Edit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Un_do", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Z", lambda w,e: self.editor.textview.undo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/_Redo", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;Z", lambda w,e: self.editor.textview.redo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Insert Screenshot",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Insert", lambda w,e: self.on_screenshot(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Format", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Left Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;L", lambda w,e: self.on_left_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/C_enter Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;E", lambda w,e: self.on_center_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Right Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;R", lambda w,e: self.on_right_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Bold", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;B", lambda w,e: self.on_bold(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Italic", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;I", lambda w,e: self.on_italic(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Underline", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;U", lambda w,e: self.on_underline(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep2", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/Choose _Font", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;F", lambda w, e: self.on_choose_font(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Go", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Tree View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;T", lambda w,e: self.on_goto_treeview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _List View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Y", lambda w,e: self.on_goto_listview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Editor",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;D", lambda w,e: self.on_goto_editor(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help", &nbsp; &nbsp; &nbsp; None, None, 0, "&lt;LastBranch&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help/About", None, lambda w,e: self.on_about(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;accel_group = gtk.AccelGroup()<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This function initializes the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 1: The type of menu - can be MenuBar, Menu,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or OptionMenu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 2: The path of the menu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 3: A reference to an AccelGroup. The item factory sets up<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the accelerator table while generating menus.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory = gtk.ItemFactory(gtk.MenuBar, "&lt;main&gt;", accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This method generates the menu items. Pass to the item factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp;the list of menu items<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory.create_items(self.menu_items)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Attach the new accelerator group to the window.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add_accel_group(accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# need to keep a reference to item_factory to prevent its destruction<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.item_factory = item_factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Finally, return the actual menu bar created by the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return item_factory.get_widget("&lt;main&gt;")<br/>
<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_toolbar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar = gtk.Toolbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_orientation(gtk.ORIENTATION_HORIZONTAL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_style(gtk.TOOLBAR_ICONS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips = gtk.Tooltips()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# bold tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "bold.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.bold_button, "Bold")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_id = self.bold_button.connect("toggled", lambda w: self.editor.textview.on_bold())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.bold_button, -1)<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# italic tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "italic.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.italic_button, "Italic")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_id = self.italic_button.connect("toggled", lambda w: self.editor.textview.on_italic())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.italic_button, -1)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# underline tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "underline.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.underline_button, "Underline")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_id = self.underline_button.connect("toggled", lambda w: self.editor.textview.on_underline())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.underline_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# font button<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel = gtk.FontButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item = gtk.ToolItem()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item.add(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(item, "Set Font")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(item, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.connect("font-set", lambda w: self.on_font_set())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# left tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignleft.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.left_button, "Left Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_id = self.left_button.connect("toggled", lambda w: self.editor.textview.on_left_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.left_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# center tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "aligncenter.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.center_button, "Center Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_id = self.center_button.connect("toggled", lambda w: self.editor.textview.on_center_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.center_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# right tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignright.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.right_button, "Right Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_id = self.right_button.connect("toggled", lambda w: self.editor.textview.on_right_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.right_button, -1) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return toolbar<br/>
<br/>
<br/>
class TakeNote (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;global BASEDIR<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;BASEDIR = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window = TakeNoteWindow(basedir)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window.open_notebook(filename)<br/>
<br/>
"""<br/>
 &nbsp; &nbsp;TakeNote<br/>
 &nbsp; &nbsp;Copyright Matt Rasmussen 2008<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;Graphical User Interface for TakeNote Application<br/>
"""<br/>
<br/>
# TODO: shade undo/redo<br/>
# TODO: add pages in treeview<br/>
# &nbsp; &nbsp; &nbsp; will eventually require lazy loading for treeview<br/>
# TODO: add framework for customized page selector columns<br/>
# TODO: add html links<br/>
# TODO: make better font selector<br/>
# TODO: add colored text<br/>
<br/>
<br/>
<br/>
# python imports<br/>
import sys, os, tempfile, re<br/>
<br/>
# pygtk imports<br/>
import pygtk<br/>
pygtk.require('2.0')<br/>
import gtk, gobject, pango<br/>
from gtk import gdk<br/>
<br/>
# takenote imports<br/>
import takenotelib as takenote<br/>
from takenotelib.undo import UndoStack<br/>
from takenotelib.richtext import RichTextView, RichTextImage<br/>
<br/>
# constants<br/>
PROGRAM_NAME = "TakeNode"<br/>
PROGRAM_VERSION = "0.1"<br/>
<br/>
DROP_YES = ("drop_yes", gtk.TARGET_SAME_WIDGET, 0)<br/>
DROP_NO = ("drop_no", gtk.TARGET_SAME_WIDGET, 0)<br/>
<br/>
<br/>
BASEDIR = ""<br/>
def get_resource(*path_list):<br/>
 &nbsp; &nbsp;return os.path.join(BASEDIR, *path_list)<br/>
<br/>
<br/>
def compute_new_path(model, target, drop_position):<br/>
 &nbsp; &nbsp;path = model.get_path(target)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER: &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path + (0,) #model.get_n_children(target),)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path[:-1] + (path[-1] + 1,)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
<br/>
def copy_row(treeview, model, source, target, drop_position):<br/>
<br/>
 &nbsp; &nbsp;# move source row<br/>
 &nbsp; &nbsp;source_row = model[source]<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.prepend(target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_before(None, target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_after(None, target, source_row)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
 &nbsp; &nbsp;# recursively move children<br/>
 &nbsp; &nbsp;for n in range(model.iter_n_children(source)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;child = model.iter_nth_child(source, n)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, child, new,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gtk.TREE_VIEW_DROP_INTO_OR_BEFORE)<br/>
<br/>
 &nbsp; &nbsp;# expand view to keep the same expansion pattern<br/>
 &nbsp; &nbsp;source_is_expanded = treeview.row_expanded(model.get_path(source))<br/>
 &nbsp; &nbsp;new_path = model.get_path(new)<br/>
 &nbsp; &nbsp;if source_is_expanded:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_to_path(new_path)<br/>
<br/>
 &nbsp; &nbsp;return new_path<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
class DataMap (object):<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path = {}<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data = {}<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_path(self, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.data2path.get(data, None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_data(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if isinstance(path, str):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = str2path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data.get(path, None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;assert data is not None, path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path_all(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively remove path and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for child in get_child_data(data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child_path = self.get_path(child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if child_path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.remove_path_all(child_path, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path(self, path, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path_all(self, path, data, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively add paths for data and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_path_all(path + (i,), child, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def clear_path(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data.clear()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def assert_path(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path2 = path + (i,)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child2 = self.get_data(path2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;assert child2 == child<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.assert_path(path2, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
def str2path(pathtext):<br/>
 &nbsp; &nbsp;"""Converts str to tuple path"""<br/>
 &nbsp; &nbsp;# sometime GTK returns a str instead of a tuple for a path... weird<br/>
 &nbsp; &nbsp;return tuple(map(int, pathtext.split(":")))<br/>
<br/>
<br/>
def dnd_sanity_check(source_path, target_path):<br/>
 &nbsp; &nbsp;"""The target cannot be a descendant of the source<br/>
 &nbsp; &nbsp; &nbsp; i.e. You cannot become your descendent's child<br/>
 &nbsp; &nbsp; &nbsp; i.e. The source path cannot be a prefix of the target path"""<br/>
 &nbsp; &nbsp;return source_path != target_path[:len(source_path)]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
<br/>
class TakeNoteTreeView (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a TreeStore with one string column to use as the model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.TreeStore(gdk.Pixbuf, str, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.expanded_id = self.treeview.connect("row-expanded", self.on_row_expanded)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.collapsed_id = self.treeview.connect("row-collapsed", self.on_row_collapsed) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-data-received", self.on_drag_data_received)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.get_selection().set_mode(gtk.SELECTION_MULTIPLE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_headers_visible(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_property("enable-tree-lines", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# make treeview searchable<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_search_column(1) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_reorderable(True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True) &nbsp; &nbsp; &nbsp; <br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create the treeview column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_clickable(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a cell renderers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# add the cells to column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in treestore<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = pixbuf = gdk.pixbuf_new_from_file(get_resource("images", "open.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_drag_data_received(self, treeview, drag_context, x, y,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;selection_data, info, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target = model.get_iter(target_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drop is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(source_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record old and new parent paths<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = source_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_path = compute_new_path(self.model, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent_path = new_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent = self.datamap.get_data(new_parent_path)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# remove obsolete model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(new_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(old_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in notebook model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.move(new_parent, new_path[-1])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in tree model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, source, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record new model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(new_parent_path, new_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path2 = self.datamap.get_path(old_parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent_path2 is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = old_parent_path2<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(old_parent_path, old_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# DEBUG: assert that all mappings are correct<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.assert_path((0,), lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# make sure to show new children<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_row(target_path, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(True, True, eventtime)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(False, False, eventtime)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def drop_allowed(self, source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Determine if drop is allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return dnd_sanity_check(source_path, target_path) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not (target_path == (0,) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(drop_position == gtk.TREE_VIEW_DROP_BEFORE or <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_AFTER))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_row_expanded(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(True)<br/>
<br/>
 &nbsp; &nbsp;def on_row_collapsed(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(False)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename '%s'" % node.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(self.datamap.get_data(paths[0]))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_node(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if parent is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# warn<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "Cannot delete notebook's toplevel directory"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#==============================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;root = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(None, root)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def expand_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_node(self, parent, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append(parent, [self.icon, node.get_title(), node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node.is_expanded():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(self.datamap.get_path(node))<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;expanded = self.treeview.row_expanded(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in self.model[path].iterchildren():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(child.path, lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.remove(child.iter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
class SelectorColumn (object):<br/>
 &nbsp; &nbsp;def __init__(self, name, kind, col):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.name = name<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.kind = kind<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.col = col<br/>
<br/>
TITLE_COLUMN = SelectorColumn("Title", str, 0)<br/>
CREATED_COLUMN = SelectorColumn("Created", str, 1)<br/>
MODIFIED_COLUMN = SelectorColumn("Modified", str, 2)<br/>
<br/>
<br/>
class TakeNoteSelector (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_status = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.display_columns = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.ListStore(gdk.Pixbuf, str, str, int, str, int, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.connect("rows-reordered", self.on_rows_reordered)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init view<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_rules_hint(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_title("Title")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_sort_column_id(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Created")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(3)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Modified")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 4)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = gdk.pixbuf_new_from_file(get_resource("images", "copy.xpm"))<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Create a new scrolled window, with scrollbars only if needed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC) #gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#print "drag"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_rows_reordered(self, treemodel, path, it, new_order):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;nrows = self.model.iter_n_children(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i in xrange(nrows):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path((i,), self.model[(i,)][6])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_page()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if page.get_title() != new_text:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename page '%s'" % page.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(paths[0])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.update()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#====================================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_nodes(self, nodes):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = nodes<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;npages = 0<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for node in nodes:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for page in node.get_pages():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;npages += 1<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if npages != 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("%d pages" % npages, "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("1 page", "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(self.model)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view_nodes(self.sel_nodes) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def _set_page(self, it, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 0, self.icon) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 1, page.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 2, page.get_created_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 3, page.get_created_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 4, page.get_modified_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 5, page.get_modified_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 6, page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path, col = self.treeview.get_cursor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def select_pages(self, pages):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = pages[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path != None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_status:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_status(text, bar=bar)<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
class TakeNoteEditor (object):<br/>
<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview = RichTextView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.add(self.textview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = sw<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if page is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.disable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.enable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.load(page.get_data_file())<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.page is not None and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.page.is_valid() and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.textview.is_modified():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.save(self.page.get_data_file())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.set_modified_time()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.on_page_modified:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified(self.page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save_needed(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.textview.is_modified()<br/>
<br/>
<br/>
class TakeNoteWindow (gtk.Window):<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_title("TakeNote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_default_size(*takenote.DEFAULT_WINDOW_SIZE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.connect("delete-event", lambda w,e: self.on_close())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# selector<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector = TakeNoteSelector()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_select_node = self.on_select_page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_status = self.set_status<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = TakeNoteTreeView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.on_select_node = self.on_select_treenode<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# editor<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor = TakeNoteEditor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.font_callback = self.on_font_change<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.on_page_modified = self.on_page_modified<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#====================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Layout<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# vertical box<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add(main_vbox)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;menubar = self.make_menubar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(menubar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# toolbar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(self.make_toolbar(), False, True, 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2 = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.set_border_width(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(main_vbox2, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#==========================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a horizontal paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned = gtk.HPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.pack_start(self.hpaned, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(takenote.DEFAULT_HSASH_POS)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a vertical paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned = gtk.VPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add2(self.vpaned)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(takenote.DEFAULT_VSASH_POS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# status bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox = gtk.HBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(status_hbox, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar = gtk.Statusbar() &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.status_bar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_property("has-resize-grip", False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_size_request(300, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar = gtk.Statusbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.stats_bar, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# layout major widgets<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add1(self.treeview.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add1(self.selector.view) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add2(self.editor.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.show_all() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if bar == "status":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif bar == "stats":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown bar '%s'" % bar)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.resize(*self.notebook.pref.window_size)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook.pref.window_pos != [-1, -1]:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.move(*self.notebook.pref.window_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(self.notebook.pref.vsash_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(self.notebook.pref.hsash_pos)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_size = self.get_size()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_pos = self.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.vsash_pos = self.vpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.hsash_pos = self.hpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_new_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("New Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_CREATE_FOLDER,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "New", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_new_notebook_response)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.rmdir(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.new_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("Open Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_OPEN,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Open", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_open_notebook_response)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*.nbk")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("Notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("All files")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def new_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.create()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Created '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Error: Could not create new notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename, new=True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename, new=False):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.load(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.get_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if not new:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Loaded '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def close_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_dir(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_dir("New Node")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_page("New Page")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed = self.notebook.save_needed() or \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.editor.save_needed()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if needed:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Notebook saved")<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_close(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""close the window and quit"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.main_quit()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return False<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_treenode(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = [node]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([])<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_page_modified(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update_node(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================================<br/>
 &nbsp; &nbsp;# Font UI Update<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_change(self, mods, justify):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# block toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_block(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_block(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_block(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update font mods<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"]) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update text justification<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_active(justify == "left")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_active(justify == "center")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_active(justify == "right") &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# unblock toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_unblock(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_unblock(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_unblock(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_bold(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_bold()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_italic(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_italic()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_underline(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_underline()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_left_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_left_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_center_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_center_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_right_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_right_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<br/>
 &nbsp; &nbsp;def on_screenshot(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.current_page == None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;f, imgfile = tempfile.mkstemp(".xpm", "takenote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.close(f)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.system("import %s" % imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(imgfile):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pixbuf = gdk.pixbuf_new_from_file(imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img = RichTextImage()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img.set_from_pixbuf(pixbuf)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.insert_image(img, "screenshot.jpg")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "error reading screenshot '%s'" % imgfile<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.remove(imgfile) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_choose_font(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.clicked()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_set(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_font_set(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_treeview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_listview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_editor(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_about(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Display about dialog"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about = gtk.AboutDialog()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_name(PROGRAM_NAME)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_version("v%s" % (PROGRAM_VERSION) )<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_copyright("Copyright Matt Rasmussen 2008")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_transient_for(self)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_position(gtk.WIN_POS_CENTER_ON_PARENT)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.connect("response", lambda d,r: about.destroy())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#================================================<br/>
 &nbsp; &nbsp;# Menubar<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_menubar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.menu_items = (<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_File", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_New Notebook",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, lambda w,e: self.on_new_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Page", &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;N", lambda w,e: self.on_new_page(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Directory", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;N", lambda w,e: self.on_new_dir(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Open Notebook", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;O", lambda w,e: self.on_open_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Save", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;S", lambda w,e: self.on_save(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Close Notebook", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;W", lambda w, e: self.close_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/Quit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Q", lambda w,e: self.on_close(), 0, None),<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Edit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Un_do", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Z", lambda w,e: self.editor.textview.undo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/_Redo", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;Z", lambda w,e: self.editor.textview.redo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Insert Screenshot",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Insert", lambda w,e: self.on_screenshot(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Format", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Left Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;L", lambda w,e: self.on_left_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/C_enter Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;E", lambda w,e: self.on_center_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Right Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;R", lambda w,e: self.on_right_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Bold", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;B", lambda w,e: self.on_bold(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Italic", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;I", lambda w,e: self.on_italic(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Underline", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;U", lambda w,e: self.on_underline(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep2", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/Choose _Font", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;F", lambda w, e: self.on_choose_font(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Go", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Tree View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;T", lambda w,e: self.on_goto_treeview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _List View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Y", lambda w,e: self.on_goto_listview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Editor",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;D", lambda w,e: self.on_goto_editor(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help", &nbsp; &nbsp; &nbsp; None, None, 0, "&lt;LastBranch&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help/About", None, lambda w,e: self.on_about(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;accel_group = gtk.AccelGroup()<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This function initializes the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 1: The type of menu - can be MenuBar, Menu,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or OptionMenu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 2: The path of the menu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 3: A reference to an AccelGroup. The item factory sets up<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the accelerator table while generating menus.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory = gtk.ItemFactory(gtk.MenuBar, "&lt;main&gt;", accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This method generates the menu items. Pass to the item factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp;the list of menu items<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory.create_items(self.menu_items)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Attach the new accelerator group to the window.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add_accel_group(accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# need to keep a reference to item_factory to prevent its destruction<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.item_factory = item_factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Finally, return the actual menu bar created by the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return item_factory.get_widget("&lt;main&gt;")<br/>
<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_toolbar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar = gtk.Toolbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_orientation(gtk.ORIENTATION_HORIZONTAL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_style(gtk.TOOLBAR_ICONS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips = gtk.Tooltips()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# bold tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "bold.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.bold_button, "Bold")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_id = self.bold_button.connect("toggled", lambda w: self.editor.textview.on_bold())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.bold_button, -1)<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# italic tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "italic.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.italic_button, "Italic")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_id = self.italic_button.connect("toggled", lambda w: self.editor.textview.on_italic())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.italic_button, -1)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# underline tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "underline.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.underline_button, "Underline")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_id = self.underline_button.connect("toggled", lambda w: self.editor.textview.on_underline())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.underline_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# font button<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel = gtk.FontButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item = gtk.ToolItem()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item.add(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(item, "Set Font")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(item, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.connect("font-set", lambda w: self.on_font_set())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# left tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignleft.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.left_button, "Left Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_id = self.left_button.connect("toggled", lambda w: self.editor.textview.on_left_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.left_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# center tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "aligncenter.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.center_button, "Center Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_id = self.center_button.connect("toggled", lambda w: self.editor.textview.on_center_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.center_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# right tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignright.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.right_button, "Right Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_id = self.right_button.connect("toggled", lambda w: self.editor.textview.on_right_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.right_button, -1) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return toolbar<br/>
<br/>
<br/>
class TakeNote (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;global BASEDIR<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;BASEDIR = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window = TakeNoteWindow(basedir)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window.open_notebook(filename)<br/>
<br/>
"""<br/>
 &nbsp; &nbsp;TakeNote<br/>
 &nbsp; &nbsp;Copyright Matt Rasmussen 2008<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;Graphical User Interface for TakeNote Application<br/>
"""<br/>
<br/>
# TODO: shade undo/redo<br/>
# TODO: add pages in treeview<br/>
# &nbsp; &nbsp; &nbsp; will eventually require lazy loading for treeview<br/>
# TODO: add framework for customized page selector columns<br/>
# TODO: add html links<br/>
# TODO: make better font selector<br/>
# TODO: add colored text<br/>
<br/>
<br/>
<br/>
# python imports<br/>
import sys, os, tempfile, re<br/>
<br/>
# pygtk imports<br/>
import pygtk<br/>
pygtk.require('2.0')<br/>
import gtk, gobject, pango<br/>
from gtk import gdk<br/>
<br/>
# takenote imports<br/>
import takenotelib as takenote<br/>
from takenotelib.undo import UndoStack<br/>
from takenotelib.richtext import RichTextView, RichTextImage<br/>
<br/>
# constants<br/>
PROGRAM_NAME = "TakeNode"<br/>
PROGRAM_VERSION = "0.1"<br/>
<br/>
DROP_YES = ("drop_yes", gtk.TARGET_SAME_WIDGET, 0)<br/>
DROP_NO = ("drop_no", gtk.TARGET_SAME_WIDGET, 0)<br/>
<br/>
<br/>
BASEDIR = ""<br/>
def get_resource(*path_list):<br/>
 &nbsp; &nbsp;return os.path.join(BASEDIR, *path_list)<br/>
<br/>
<br/>
def compute_new_path(model, target, drop_position):<br/>
 &nbsp; &nbsp;path = model.get_path(target)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER: &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path + (0,) #model.get_n_children(target),)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return path[:-1] + (path[-1] + 1,)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
<br/>
def copy_row(treeview, model, source, target, drop_position):<br/>
<br/>
 &nbsp; &nbsp;# move source row<br/>
 &nbsp; &nbsp;source_row = model[source]<br/>
 &nbsp; &nbsp;if drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or \<br/>
 &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.prepend(target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_BEFORE:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_before(None, target, source_row)<br/>
 &nbsp; &nbsp;elif drop_position == gtk.TREE_VIEW_DROP_AFTER:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;new = model.insert_after(None, target, source_row)<br/>
 &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown drop position %s" %<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;str(drop_position))<br/>
<br/>
 &nbsp; &nbsp;# recursively move children<br/>
 &nbsp; &nbsp;for n in range(model.iter_n_children(source)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;child = model.iter_nth_child(source, n)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, child, new,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gtk.TREE_VIEW_DROP_INTO_OR_BEFORE)<br/>
<br/>
 &nbsp; &nbsp;# expand view to keep the same expansion pattern<br/>
 &nbsp; &nbsp;source_is_expanded = treeview.row_expanded(model.get_path(source))<br/>
 &nbsp; &nbsp;new_path = model.get_path(new)<br/>
 &nbsp; &nbsp;if source_is_expanded:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_to_path(new_path)<br/>
<br/>
 &nbsp; &nbsp;return new_path<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
class DataMap (object):<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path = {}<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data = {}<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_path(self, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.data2path.get(data, None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_data(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if isinstance(path, str):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = str2path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data.get(path, None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;assert data is not None, path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path(self, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def remove_path_all(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively remove path and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path in self.path2data:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data = self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for child in get_child_data(data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child_path = self.get_path(child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if child_path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.remove_path_all(child_path, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.path2data[path]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;del self.data2path[data]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path(self, path, data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_path_all(self, path, data, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Recursively add paths for data and all its descendants"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_path_all(path + (i,), child, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path[data] = path<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data[path] = data<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def clear_path(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.data2path.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.path2data.clear()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def assert_path(self, path, get_child_data):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;data = self.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i, child in enumerate(get_child_data(data)): &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path2 = path + (i,)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;child2 = self.get_data(path2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;assert child2 == child<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.assert_path(path2, get_child_data)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
def str2path(pathtext):<br/>
 &nbsp; &nbsp;"""Converts str to tuple path"""<br/>
 &nbsp; &nbsp;# sometime GTK returns a str instead of a tuple for a path... weird<br/>
 &nbsp; &nbsp;return tuple(map(int, pathtext.split(":")))<br/>
<br/>
<br/>
def dnd_sanity_check(source_path, target_path):<br/>
 &nbsp; &nbsp;"""The target cannot be a descendant of the source<br/>
 &nbsp; &nbsp; &nbsp; i.e. You cannot become your descendent's child<br/>
 &nbsp; &nbsp; &nbsp; i.e. The source path cannot be a prefix of the target path"""<br/>
 &nbsp; &nbsp;return source_path != target_path[:len(source_path)]<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
<br/>
<br/>
<br/>
class TakeNoteTreeView (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a TreeStore with one string column to use as the model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.TreeStore(gdk.Pixbuf, str, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.expanded_id = self.treeview.connect("row-expanded", self.on_row_expanded)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.collapsed_id = self.treeview.connect("row-collapsed", self.on_row_collapsed) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-data-received", self.on_drag_data_received)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.get_selection().set_mode(gtk.SELECTION_MULTIPLE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_headers_visible(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_property("enable-tree-lines", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# make treeview searchable<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_search_column(1) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_reorderable(True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True) &nbsp; &nbsp; &nbsp; <br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create the treeview column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_clickable(False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a cell renderers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# add the cells to column<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in treestore<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = pixbuf = gdk.pixbuf_new_from_file(get_resource("images", "open.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_drag_data_received(self, treeview, drag_context, x, y,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;selection_data, info, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target = model.get_iter(target_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drop is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(source_path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record old and new parent paths<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = source_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_path = compute_new_path(self.model, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent_path = new_path[:-1]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_parent = self.datamap.get_data(new_parent_path)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# remove obsolete model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(new_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(old_parent_path, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in notebook model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.move(new_parent, new_path[-1])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# perform move in tree model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_block(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copy_row(treeview, model, source, target, drop_position)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.expanded_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.handler_unblock(self.collapsed_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# record new model mappings<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(new_parent_path, new_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent != new_parent:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path2 = self.datamap.get_path(old_parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if old_parent_path2 is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_parent_path = old_parent_path2<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path_all(old_parent_path, old_parent,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# DEBUG: assert that all mappings are correct<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.assert_path((0,), lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# make sure to show new children<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (drop_position == gtk.TREE_VIEW_DROP_INTO_OR_BEFORE or<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drop_position == gtk.TREE_VIEW_DROP_INTO_OR_AFTER):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.expand_row(target_path, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(True, True, eventtime)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;drag_context.finish(False, False, eventtime)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def drop_allowed(self, source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Determine if drop is allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return dnd_sanity_check(source_path, target_path) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not (target_path == (0,) and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(drop_position == gtk.TREE_VIEW_DROP_BEFORE or <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; drop_position == gtk.TREE_VIEW_DROP_AFTER))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_row_expanded(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(True)<br/>
<br/>
 &nbsp; &nbsp;def on_row_collapsed(self, treeview, it, path):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.get_data(path).set_expand(False)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename '%s'" % node.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(self.datamap.get_data(paths[0]))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_node(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;parent = node.get_parent()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if parent is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# warn<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "Cannot delete notebook's toplevel directory"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#==============================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;root = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(None, root)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def expand_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def add_node(self, parent, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append(parent, [self.icon, node.get_title(), node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node.is_expanded():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(self.datamap.get_path(node))<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;expanded = self.treeview.row_expanded(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in self.model[path].iterchildren():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path_all(child.path, lambda x: x.get_children())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.remove(child.iter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for child in node.get_children():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.add_node(it, child)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_to_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
class SelectorColumn (object):<br/>
 &nbsp; &nbsp;def __init__(self, name, kind, col):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.name = name<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.kind = kind<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.col = col<br/>
<br/>
TITLE_COLUMN = SelectorColumn("Title", str, 0)<br/>
CREATED_COLUMN = SelectorColumn("Created", str, 1)<br/>
MODIFIED_COLUMN = SelectorColumn("Modified", str, 2)<br/>
<br/>
<br/>
class TakeNoteSelector (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_status = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.display_columns = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model = gtk.ListStore(gdk.Pixbuf, str, str, int, str, int, object)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.connect("rows-reordered", self.on_rows_reordered)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap = DataMap() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# init view<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = gtk.TreeView(self.model)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("key-release-event", self.on_key_released) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.get_selection().connect("changed", self.on_select_changed)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.connect("drag-motion", self.on_drag_motion)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_rules_hint(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_source(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;gtk.gdk.BUTTON1_MASK, [DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.enable_model_drag_dest(<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[DROP_YES], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#self.treeview.set_fixed_height_mode(True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_icon = gtk.CellRendererPixbuf()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_title("Title")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(self.column)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(cell_icon, False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.pack_start(self.cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.connect("edited", self.on_edit_title)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.cell_text.set_property("editable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.set_sort_column_id(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# map cells to columns in model<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(cell_icon, 'pixbuf', 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.column.add_attribute(self.cell_text, 'text', 1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Created")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(3)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 2)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;cell_text = gtk.CellRendererText()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column = gtk.TreeViewColumn()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_property("resizable", True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_sort_column_id(5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_sizing(gtk.TREE_VIEW_COLUMN_FIXED)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#column.set_property("min-width", 5)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.set_title("Modified")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.pack_start(cell_text, True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;column.add_attribute(cell_text, 'text', 4)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.append_column(column) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.icon = gdk.pixbuf_new_from_file(get_resource("images", "copy.xpm"))<br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Create a new scrolled window, with scrollbars only if needed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_policy(gtk.POLICY_NEVER, gtk.POLICY_AUTOMATIC) #gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.set_shadow_type(gtk.SHADOW_IN) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;scrolled_window.add(self.treeview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = scrolled_window<br/>
<br/>
 &nbsp; &nbsp;#=============================================<br/>
 &nbsp; &nbsp;# gui callbacks<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_drag_motion(self, treeview, drag_context, x, y, eventtime):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Callback for drag motion.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Indicate which drops are allowed"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#print "drag"<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine destination row &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;dest_row = treeview.get_dest_row_at_pos(x, y)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if dest_row is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# get target and source<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;target_path, drop_position &nbsp;= dest_row &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, source = treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;source_path = model.get_path(source)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# determine if drag is allowed<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.drop_allowed(source_path, target_path, drop_position):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_YES], gtk.gdk.ACTION_MOVE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;treeview.enable_model_drag_dest([DROP_NO], gtk.gdk.ACTION_MOVE) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_rows_reordered(self, treemodel, path, it, new_order):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;nrows = self.model.iter_n_children(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for i in xrange(nrows):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path((i,), self.model[(i,)][6])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_key_released(self, widget, event):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if event.keyval == gdk.keyval_from_name("Delete"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_delete_page()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.stop_emission("key-release-event")<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_edit_title(self, cellrenderertext, path, new_text):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if page.get_title() != new_text:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;page.rename(new_text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model[path][1] = new_text<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "takenote: could not rename page '%s'" % page.get_title()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_changed(self, treeselect): <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, paths = treeselect.get_selected_rows()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(paths) &gt; 0 and self.on_select_node:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node = self.datamap.get_data(paths[0])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return True<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_delete_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;model, it = self.treeview.get_selection().get_selected()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = self.datamap.get_data(model.get_path(it))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.remove_path(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page.delete()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.update()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#====================================================<br/>
 &nbsp; &nbsp;# actions<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_nodes(self, nodes):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(None)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = nodes<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;npages = 0<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;for node in nodes:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for page in node.get_pages():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;npages += 1<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.append()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;path = self.model.get_path(it)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.add_path(path, page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_select_node(None) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if npages != 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("%d pages" % npages, "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("1 page", "stats")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_model(self.model)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view_nodes(self.sel_nodes) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def update_node(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(node)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;it = self.model.get_iter(path)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._set_page(it, node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def _set_page(self, it, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 0, self.icon) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 1, page.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 2, page.get_created_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 3, page.get_created_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 4, page.get_modified_time_text())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 5, page.get_modified_time())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.model.set(it, 6, page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def edit_node(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path, self.column, self.cell_text, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path, col = self.treeview.get_cursor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.scroll_to_cell(path)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def select_pages(self, pages):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;page = pages[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;path = self.datamap.get_path(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if path != None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_cursor_on_cell(path)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_notebook(self, notebook):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = notebook<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.model.clear()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.datamap.clear_path()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.on_status:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_status(text, bar=bar)<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
class TakeNoteEditor (object):<br/>
<br/>
 &nbsp; &nbsp;def __init__(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw = gtk.ScrolledWindow()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_policy(gtk.POLICY_AUTOMATIC, gtk.POLICY_AUTOMATIC)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.set_shadow_type(gtk.SHADOW_IN)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview = RichTextView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.add(self.textview)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;sw.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.textview.show()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.view = sw<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def view_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if page is None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.disable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.enable()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.load(page.get_data_file())<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.page is not None and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.page.is_valid() and \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.textview.is_modified():<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.textview.save(self.page.get_data_file())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.set_modified_time()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.page.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.on_page_modified:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.on_page_modified(self.page)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def save_needed(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return self.textview.is_modified()<br/>
<br/>
<br/>
class TakeNoteWindow (gtk.Window):<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.Window.__init__(self, gtk.WINDOW_TOPLEVEL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_title("TakeNote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.set_default_size(*takenote.DEFAULT_WINDOW_SIZE)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.connect("delete-event", lambda w,e: self.on_close())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# selector<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector = TakeNoteSelector()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_select_node = self.on_select_page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.on_status = self.set_status<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# treeview<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview = TakeNoteTreeView()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.on_select_node = self.on_select_treenode<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# editor<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor = TakeNoteEditor()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.font_callback = self.on_font_change<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.on_page_modified = self.on_page_modified<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(None)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#====================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Layout<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# vertical box<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add(main_vbox)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;menubar = self.make_menubar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(menubar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# toolbar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(self.make_toolbar(), False, True, 0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2 = gtk.VBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.set_border_width(1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(main_vbox2, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;#==========================================<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a horizontal paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned = gtk.HPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox2.pack_start(self.hpaned, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(takenote.DEFAULT_HSASH_POS)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# create a vertical paned widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned = gtk.VPaned()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add2(self.vpaned)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(takenote.DEFAULT_VSASH_POS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# status bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox = gtk.HBox(False, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;main_vbox.pack_start(status_hbox, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar = gtk.Statusbar() &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.status_bar, False, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_property("has-resize-grip", False)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.set_size_request(300, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar = gtk.Statusbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;status_hbox.pack_start(self.stats_bar, True, True, 0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# layout major widgets<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.add1(self.treeview.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add1(self.selector.view) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.add2(self.editor.view)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.show_all() &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_status(self, text, bar="status"):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if bar == "status":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.status_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif bar == "stats":<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.pop(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.stats_bar.push(0, text)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raise Exception("unknown bar '%s'" % bar)<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def get_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.resize(*self.notebook.pref.window_size)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook.pref.window_pos != [-1, -1]:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.move(*self.notebook.pref.window_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.vpaned.set_position(self.notebook.pref.vsash_pos)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.hpaned.set_position(self.notebook.pref.hsash_pos)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def set_preferences(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_size = self.get_size()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.window_pos = self.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.vsash_pos = self.vpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.pref.hsash_pos = self.hpaned.get_position()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_new_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("New Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_CREATE_FOLDER,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "New", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_new_notebook_response)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.rmdir(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.new_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew = gtk.FileChooserDialog("Open Notebook", self, <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;action=gtk.FILE_CHOOSER_ACTION_OPEN,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;buttons=("Cancel", gtk.RESPONSE_CANCEL,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "Open", gtk.RESPONSE_OK))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.connect("response", self.on_open_notebook_response)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*.nbk")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("Notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter = gtk.FileFilter()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.add_pattern("*")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;file_filter.set_name("All files")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.add_filter(file_filter)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.filew.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_open_notebook_response(self, dialog, response):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if response == gtk.RESPONSE_OK:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filename = self.filew.get_filename()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;elif response == gtk.RESPONSE_CANCEL:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;dialog.destroy()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def new_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.create()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Created '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Error: Could not create new notebook")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.open_notebook(filename, new=True)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename, new=False):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = takenote.NoteBook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.load(filename)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.get_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if not new:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Loaded '%s'" % self.notebook.get_title())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def close_notebook(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_preferences()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook = None<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.set_notebook(self.notebook)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_dir(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_dir("New Node")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.expand_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_new_page(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if len(self.sel_nodes) == 1:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.sel_nodes[0]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parent = self.notebook.get_root_node()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;node = parent.new_page("New Page")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.update_node(parent)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.edit_node(node)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_save(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.notebook is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed = self.notebook.save_needed() or \<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.editor.save_needed()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.notebook.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.save()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if needed:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.set_status("Notebook saved")<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_close(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""close the window and quit"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.close_notebook()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;gtk.main_quit()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return False<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_select_treenode(self, node):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if node is not None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = [node]<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([node])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;else:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.sel_nodes = []<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.selector.view_nodes([])<br/>
 &nbsp; &nbsp;<br/>
<span style="font-size: 40pt"><span style="font-family: Serif"> &nbsp; &nbsp;def on_select_page(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.current_page = page<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.view_page(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_page_modified(self, page):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.update_node(page)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#=============================================================<br/>
 &nbsp; &nbsp;# Font UI Update<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_change(self, mods, justify):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# block toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_block(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_block(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_block(self.right_id) </span></span><br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update font mods<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"]) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# update text justification<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_active(justify == "left")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_active(justify == "center")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_active(justify == "right") &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# unblock toolbar handlers<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.handler_unblock(self.left_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.handler_unblock(self.center_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.handler_unblock(self.right_id) <br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_bold(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_bold()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_block(self.bold_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_active(mods["bold"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.handler_unblock(self.bold_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_italic(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_italic()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_active(mods["italic"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.handler_block(self.italic_id)<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
<b> &nbsp; &nbsp;def on_underline(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_underline()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_block(self.underline_id) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_active(mods["underline"])<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.handler_unblock(self.underline_id)<br/>
 &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_left_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_left_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()</b><br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
 &nbsp; &nbsp;def on_center_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_center_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<b> &nbsp; &nbsp;def on_right_justify(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_right_justify()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;mods, justify = self.editor.textview.get_font()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.on_font_change(mods, justify)<br/>
<br/>
<br/>
 &nbsp; &nbsp;def on_screenshot(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if self.current_page == None:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;f, imgfile = tempfile.mkstemp(".xpm", "takenote")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.close(f)</b><br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;os.system("import %s" % imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;if os.path.exists(imgfile):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pixbuf = gdk.pixbuf_new_from_file(imgfile)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img = RichTextImage()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;img.set_from_pixbuf(pixbuf)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.insert_image(img, "screenshot.jpg")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except Exception, e:<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print e<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;print "error reading screenshot '%s'" % imgfile<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<i><u><b> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;os.remove(imgfile) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp;def on_choose_font(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.clicked()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_font_set(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.on_font_set(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()</b></u></i><br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_treeview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.treeview.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_listview(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.selector.treeview.grab_focus()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_goto_editor(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.editor.textview.grab_focus()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def on_about(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;"""Display about dialog"""<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about = gtk.AboutDialog()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_name(PROGRAM_NAME)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_version("v%s" % (PROGRAM_VERSION) )<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_copyright("Copyright Matt Rasmussen 2008")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_transient_for(self)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.set_position(gtk.WIN_POS_CENTER_ON_PARENT)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.connect("response", lambda d,r: about.destroy())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;about.show()<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;#================================================<br/>
 &nbsp; &nbsp;# Menubar<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_menubar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# menu bar<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.menu_items = (<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_File", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_New Notebook",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, lambda w,e: self.on_new_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Page", &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;N", lambda w,e: self.on_new_page(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/New _Directory", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;N", lambda w,e: self.on_new_dir(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Open Notebook", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;O", lambda w,e: self.on_open_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Save", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;S", lambda w,e: self.on_save(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/_Close Notebook", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;W", lambda w, e: self.close_notebook(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/File/Quit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Q", lambda w,e: self.on_close(), 0, None),<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Edit", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Un_do", &nbsp; &nbsp; <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Z", lambda w,e: self.editor.textview.undo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/_Redo", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;Z", lambda w,e: self.editor.textview.redo(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Edit/Insert Screenshot",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Insert", lambda w,e: self.on_screenshot(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Format", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Left Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;L", lambda w,e: self.on_left_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/C_enter Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;E", lambda w,e: self.on_center_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Right Align", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;R", lambda w,e: self.on_right_justify(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep1", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Bold", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;B", lambda w,e: self.on_bold(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Italic", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;I", lambda w,e: self.on_italic(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/_Underline", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;U", lambda w,e: self.on_underline(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/sep2", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Separator&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Format/Choose _Font", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;&lt;shift&gt;F", lambda w, e: self.on_choose_font(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Go", <br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;None, None, 0, "&lt;Branch&gt;"),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Tree View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;T", lambda w,e: self.on_goto_treeview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _List View",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;Y", lambda w,e: self.on_goto_listview(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/Go/Go To _Editor",<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"&lt;control&gt;D", lambda w,e: self.on_goto_editor(), 0, None),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help", &nbsp; &nbsp; &nbsp; None, None, 0, "&lt;LastBranch&gt;" ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;("/_Help/About", None, lambda w,e: self.on_about(), 0, None ),<br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;) &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;accel_group = gtk.AccelGroup()<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# This function initializes the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 1: The type of menu - can be MenuBar, Menu,<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;or OptionMenu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 2: The path of the menu.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Param 3: A reference to an AccelGroup. The item factory sets up<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the accelerator table while generating menus.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory = gtk.ItemFactory(gtk.MenuBar, "&lt;main&gt;", accel_group)<br/>
<br/>
<i> &nbsp; &nbsp; &nbsp; &nbsp;# This method generates the menu items. Pass to the item factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp;the list of menu items<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item_factory.create_items(self.menu_items)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<b># Attach the new accelerator group to the window.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.add_accel_group(accel_group)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# need to keep a reference to item_factory to prevent its destruction<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.item_factory = item_factory<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# Finally, return the actual menu bar created by the item factory.<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return item_factory.get_widget("&lt;main&gt;")</b><br/>
<br/>
<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def make_toolbar(self):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar = gtk.Toolbar()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_orientation(gtk.ORIENTATION_HORIZONTAL)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_style(gtk.TOOLBAR_ICONS)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.set_border_width(0)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips = gtk.Tooltips()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# bold tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "bold.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.bold_button, "Bold")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.bold_id = self.bold_button.connect("toggled", lambda w: self.editor.textview.on_bold())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.bold_button, -1)</i><br/>
<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# italic tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "italic.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.italic_button, "Italic")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.italic_id = self.italic_button.connect("toggled", lambda w: self.editor.textview.on_italic())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.italic_button, -1)<br/>
<br/>
<b> &nbsp; &nbsp; &nbsp; &nbsp;# underline tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "underline.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.underline_button, "Underline")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.underline_id = self.underline_button.connect("toggled", lambda w: self.editor.textview.on_underline())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.underline_button, -1)</b><br/>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# font button<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel = gtk.FontButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item = gtk.ToolItem()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;item.add(self.font_sel)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(item, "Set Font")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(item, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.font_sel.connect("font-set", lambda w: self.on_font_set())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
<b> &nbsp; &nbsp; &nbsp; &nbsp;# left tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignleft.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.left_button, "Left Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.left_id = self.left_button.connect("toggled", lambda w: self.editor.textview.on_left_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.left_button, -1)</b><br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# center tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "aligncenter.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button = gtk.ToggleToolButton()<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.center_button, "Center Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.center_id = self.center_button.connect("toggled", lambda w: self.editor.textview.on_center_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.center_button, -1)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;# right tool<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon = gtk.Image() # icon widget<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;icon.set_from_file(get_resource("images", "alignright.xpm"))<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_button = gtk.ToggleToolButton()<br/>
<u> &nbsp; &nbsp; &nbsp; &nbsp;self.right_button.set_icon_widget(icon)<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;tips.set_tip(self.right_button, "Right Justify")<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.right_id = self.right_button.connect("toggled", lambda w: self.editor.textview.on_right_justify())<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;toolbar.insert(self.right_button, -1) &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;return toolbar</u><br/>
<br/>
<br/>
<b>class TakeNote (object):<br/>
 &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def __init__(self, basedir=""):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.basedir = basedir<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;global BASEDIR<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;BASEDIR = basedir<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window = TakeNoteWindow(basedir)<br/>
<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;<br/>
 &nbsp; &nbsp;def open_notebook(self, filename):<br/>
 &nbsp; &nbsp; &nbsp; &nbsp;self.window.open_notebook(filename)</b><br/>
<br/>
</body></html>